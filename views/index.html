<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Static Ads Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    :root{
      --bg:#07080f;
      --surface:#0d0f1a;
      --surface2:#111526;
      --border:#1e2235;
      --border2:#252a40;
      --accent:#6366f1;
      --accent2:#8b5cf6;
      --text:#e2e8f0;
      --muted:#64748b;
      --muted2:#94a3b8;
    }
    /* ‚îÄ‚îÄ Light theme ‚îÄ‚îÄ */
    body.light{
      --bg:#f1f5f9;
      --surface:#ffffff;
      --surface2:#f8fafc;
      --border:#e2e8f0;
      --border2:#cbd5e1;
      --text:#0f172a;
      --muted:#64748b;
      --muted2:#475569;
    }
    body.light .bg-glow,.light .bg-glow2{opacity:.3;}
    body.light ::-webkit-scrollbar-thumb{background:#cbd5e1;}
    body.light .nav-item.active{background:linear-gradient(135deg,rgba(99,102,241,.15),rgba(139,92,246,.1));color:#4f46e5;}
    body.light .logo-badge{box-shadow:0 0 16px rgba(99,102,241,.25);}
    body.light .btn-primary{box-shadow:0 0 12px rgba(99,102,241,.25);}
    body.light .card,.light .card-glow{box-shadow:0 1px 4px rgba(0,0,0,.06);}
    body.light .modal{box-shadow:0 20px 50px rgba(0,0,0,.15);}
    body.light .input{background:#f8fafc;color:#0f172a;}
    body.light .input::placeholder{color:#94a3b8;}
    body.light .drop-zone{color:#64748b;}
    body.light .toggle-track{background:#e2e8f0;border-color:#cbd5e1;}
    body.light select.input option{background:#ffffff;}
    body.light .gen-card:hover{border-color:rgba(99,102,241,.4);}
    body.light .client-select{background:#f8fafc;color:#0f172a;}
    body.light .client-select option{background:#ffffff;}
    /* theme transition */
    body,body *{transition:background-color .25s,border-color .25s,color .18s,box-shadow .25s;}
    body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;min-height:100vh;display:flex;}

    /* Scrollbar */
    ::-webkit-scrollbar{width:5px;height:5px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:#1e2235;border-radius:8px;}
    ::-webkit-scrollbar-thumb:hover{background:#252a40;}

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar{
      width:256px;min-width:256px;background:var(--surface);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      position:fixed;top:0;left:0;height:100vh;z-index:20;
    }
    .sidebar-logo{
      padding:20px 20px 16px;
      border-bottom:1px solid var(--border);
    }
    .logo-badge{
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:15px;color:white;
      box-shadow:0 0 16px rgba(99,102,241,0.4);
      flex-shrink:0;
    }
    .nav-section-label{
      font-size:10px;font-weight:600;letter-spacing:.08em;
      color:var(--muted);text-transform:uppercase;
      padding:4px 12px;margin-top:16px;margin-bottom:4px;
    }
    .nav-item{
      display:flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:8px;
      font-size:13px;font-weight:500;cursor:pointer;
      color:var(--muted2);transition:all .15s;margin:1px 8px;
    }
    .nav-item:hover{background:var(--surface2);color:var(--text);}
    .nav-item.active{
      background:linear-gradient(135deg,rgba(99,102,241,.2),rgba(139,92,246,.15));
      color:#a5b4fc;
      border:1px solid rgba(99,102,241,.25);
      box-shadow:0 0 12px rgba(99,102,241,.1);
    }
    .nav-item.active svg{color:#818cf8;}
    .nav-item svg{width:16px;height:16px;flex-shrink:0;opacity:.7;}
    .nav-item.active svg{opacity:1;}

    /* Client selector */
    .client-selector{padding:12px 16px;border-bottom:1px solid var(--border);}
    .client-select{
      width:100%;background:var(--surface2);border:1px solid var(--border2);
      border-radius:8px;padding:7px 10px;font-size:12px;color:var(--text);
      outline:none;appearance:none;cursor:pointer;
      transition:border-color .15s;
    }
    .client-select:focus{border-color:var(--accent);}
    .client-select option{background:#0d0f1a;}
    .client-actions{display:flex;gap:6px;margin-top:6px;}

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:6px;padding:8px 14px;border-radius:8px;
      font-size:13px;font-weight:500;cursor:pointer;
      transition:all .18s;border:none;outline:none;text-decoration:none;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#6366f1,#7c3aed);
      color:white;box-shadow:0 0 16px rgba(99,102,241,.35);
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,#4f46e5,#6d28d9);
      box-shadow:0 0 24px rgba(99,102,241,.55);transform:translateY(-1px);
    }
    .btn-primary:active{transform:translateY(0);}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none;}
    .btn-secondary{
      background:var(--surface2);border:1px solid var(--border2);
      color:var(--muted2);
    }
    .btn-secondary:hover{border-color:#6366f1;color:white;background:#1a1e35;}
    .btn-ghost{background:transparent;color:var(--muted2);}
    .btn-ghost:hover{color:white;background:var(--surface2);}
    .btn-danger{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.2);color:#f87171;}
    .btn-danger:hover{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.4);}
    .btn-sm{padding:5px 10px;font-size:12px;border-radius:6px;}
    .btn-xs{padding:3px 8px;font-size:11px;border-radius:5px;}
    .btn-lg{padding:11px 22px;font-size:14px;border-radius:10px;}
    .btn-icon{padding:7px;border-radius:7px;}

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card{
      background:var(--surface);border:1px solid var(--border);
      border-radius:12px;
    }
    .card-glow{
      background:var(--surface);border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 0 0 1px transparent;
      transition:border-color .2s,box-shadow .2s;
    }
    .card-glow:hover{border-color:rgba(99,102,241,.3);box-shadow:0 0 20px rgba(99,102,241,.08);}

    /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
    .input{
      width:100%;background:var(--surface2);
      border:1px solid var(--border2);
      border-radius:8px;padding:9px 12px;
      font-size:13px;color:var(--text);
      outline:none;transition:border-color .15s,box-shadow .15s;
      font-family:'Inter',system-ui,sans-serif;
    }
    .input:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.12);}
    .input::placeholder{color:var(--muted);}
    textarea.input{resize:vertical;}
    select.input{appearance:none;cursor:pointer;}
    select.input option{background:#0d0f1a;}

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tab-bar{display:flex;border-bottom:1px solid var(--border);gap:0;margin-bottom:20px;}
    .tab{
      padding:10px 16px;font-size:13px;font-weight:500;cursor:pointer;
      border-bottom:2px solid transparent;color:var(--muted);
      transition:all .15s;margin-bottom:-1px;
    }
    .tab.active{border-bottom-color:#6366f1;color:#a5b4fc;}
    .tab:hover:not(.active){color:var(--text);}

    /* ‚îÄ‚îÄ Chips/Badges ‚îÄ‚îÄ */
    .badge{
      display:inline-flex;align-items:center;gap:4px;
      font-size:11px;font-weight:500;padding:3px 8px;border-radius:20px;
    }
    .badge-green{background:rgba(16,185,129,.12);color:#34d399;border:1px solid rgba(16,185,129,.2);}
    .badge-red{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.2);}
    .badge-yellow{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.2);}
    .badge-blue{background:rgba(59,130,246,.12);color:#60a5fa;border:1px solid rgba(59,130,246,.2);}
    .badge-indigo{background:rgba(99,102,241,.15);color:#a5b4fc;border:1px solid rgba(99,102,241,.25);}
    .badge-purple{background:rgba(139,92,246,.12);color:#c4b5fd;border:1px solid rgba(139,92,246,.2);}

    /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
    .section{display:none;}
    .section.active{display:block;}

    /* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
    .page-header{margin-bottom:24px;}
    .page-title{font-size:20px;font-weight:700;color:var(--text);letter-spacing:-.02em;}
    .page-sub{font-size:13px;color:var(--muted);margin-top:3px;}

    /* ‚îÄ‚îÄ Gen cards (history) ‚îÄ‚îÄ */
    .gen-card{
      position:relative;background:var(--surface);
      border:1px solid var(--border);border-radius:12px;overflow:hidden;
      transition:border-color .2s,transform .2s;cursor:pointer;
    }
    .gen-card:hover{border-color:rgba(99,102,241,.3);transform:translateY(-2px);}
    .gen-card:hover .gen-overlay{opacity:1;}
    .gen-overlay{
      position:absolute;inset:0;
      background:linear-gradient(to top,rgba(7,8,15,.95) 40%,transparent);
      opacity:0;transition:opacity .2s;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
      padding:12px;gap:6px;
    }

    /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.75);
      backdrop-filter:blur(4px);
      z-index:50;display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal-backdrop.open{display:flex;}
    .modal{
      background:var(--surface);border:1px solid var(--border2);
      border-radius:16px;max-height:90vh;overflow-y:auto;
      box-shadow:0 25px 60px rgba(0,0,0,.6);
      animation:modalIn .18s ease-out;
    }
    @keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px);}to{opacity:1;transform:scale(1) translateY(0);}}

    /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
    .loading-spinner{
      border:2.5px solid var(--border2);border-top-color:#6366f1;
      border-radius:50%;width:20px;height:20px;
      animation:spin .7s linear infinite;flex-shrink:0;
    }
    .loading-spinner-lg{width:40px;height:40px;border-width:3px;}
    @keyframes spin{to{transform:rotate(360deg);}}

    .skeleton{
      background:linear-gradient(90deg,var(--surface) 25%,var(--surface2) 50%,var(--surface) 75%);
      background-size:200% 100%;animation:shimmer 1.6s infinite;border-radius:10px;
    }
    @keyframes shimmer{to{background-position:-200% 0;}}

    /* ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ */
    .drop-zone{
      border:1.5px dashed var(--border2);border-radius:10px;
      padding:16px;text-align:center;cursor:pointer;
      transition:all .15s;color:var(--muted);font-size:12px;
    }
    .drop-zone:hover,.drag-over{
      border-color:#6366f1;background:rgba(99,102,241,.06);color:#a5b4fc;
    }

    /* ‚îÄ‚îÄ Color swatches ‚îÄ‚îÄ */
    .color-swatch{
      width:34px;height:34px;border-radius:8px;cursor:pointer;
      border:2px solid transparent;transition:border-color .15s;flex-shrink:0;
    }
    .color-swatch:hover{border-color:white;}

    /* ‚îÄ‚îÄ Toggle switch ‚îÄ‚îÄ */
    .toggle-wrap{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .toggle{position:relative;display:inline-flex;cursor:pointer;}
    .toggle input{opacity:0;width:0;height:0;position:absolute;}
    .toggle-track{
      width:38px;height:22px;background:#1e2235;border-radius:11px;
      transition:background .2s;border:1px solid var(--border2);
    }
    .toggle input:checked+.toggle-track{background:#6366f1;border-color:#6366f1;}
    .toggle-thumb{
      position:absolute;top:3px;left:3px;
      width:14px;height:14px;background:white;border-radius:50%;
      transition:transform .2s;
    }
    .toggle input:checked~.toggle-thumb{transform:translateX(16px);}

    /* ‚îÄ‚îÄ Step circles ‚îÄ‚îÄ */
    .step-circle{
      width:26px;height:26px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:700;flex-shrink:0;
    }
    .step-done{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);}
    .step-active{background:linear-gradient(135deg,#6366f1,#7c3aed);color:white;box-shadow:0 0 10px rgba(99,102,241,.4);}
    .step-pending{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast{
      position:fixed;top:20px;right:20px;z-index:100;
      background:var(--surface2);border:1px solid var(--border2);
      border-radius:10px;padding:12px 16px;font-size:13px;
      display:flex;align-items:center;gap:10px;min-width:260px;max-width:380px;
      box-shadow:0 8px 32px rgba(0,0,0,.4);
      animation:slideIn .2s ease-out;
    }
    @keyframes slideIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
    .toast-success{border-left:3px solid #34d399;}
    .toast-error{border-left:3px solid #f87171;}
    .toast-info{border-left:3px solid #60a5fa;}

    /* ‚îÄ‚îÄ Divider ‚îÄ‚îÄ */
    .divider{border:none;border-top:1px solid var(--border);margin:16px 0;}

    /* ‚îÄ‚îÄ Main content ‚îÄ‚îÄ */
    .main{margin-left:256px;flex:1;padding:28px 32px;min-height:100vh;}

    /* ‚îÄ‚îÄ Background glow ‚îÄ‚îÄ */
    .bg-glow{
      position:fixed;pointer-events:none;z-index:0;
      width:600px;height:600px;border-radius:50%;
      background:radial-gradient(ellipse,rgba(99,102,241,.06) 0%,transparent 70%);
      top:-100px;right:-100px;
    }
    .bg-glow2{
      position:fixed;pointer-events:none;z-index:0;
      width:400px;height:400px;border-radius:50%;
      background:radial-gradient(ellipse,rgba(139,92,246,.04) 0%,transparent 70%);
      bottom:100px;left:200px;
    }
    main>*{position:relative;z-index:1;}

    /* grid line image placeholder */
    .img-placeholder{
      background:var(--surface2);
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
    }
    .label{display:block;font-size:12px;font-weight:500;color:var(--muted2);margin-bottom:5px;}
    .section-title{font-size:13px;font-weight:600;color:var(--muted2);margin-bottom:12px;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}

    /* ‚îÄ‚îÄ AutoPoster ‚îÄ‚îÄ */
    .ap-tab{
      flex:1;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;
      background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;
    }
    .ap-tab:hover{background:var(--surface2);color:var(--text);}
    .ap-tab.active{background:linear-gradient(135deg,#6366f1,#7c3aed);color:white;box-shadow:0 0 12px rgba(99,102,241,.25);}
    .ap-tab-content{display:none;}
    .ap-tab-content.active{display:block;}
    .ap-filter{
      padding:5px 14px;border-radius:20px;font-size:12px;font-weight:500;
      background:var(--surface2);border:1px solid var(--border);color:var(--muted);cursor:pointer;transition:all .15s;
    }
    .ap-filter:hover{border-color:var(--accent);color:var(--text);}
    .ap-filter.active{background:var(--accent);border-color:var(--accent);color:white;}
    .ap-post-card{
      background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .15s;
    }
    .ap-post-card:hover{border-color:var(--accent);}
    .ap-platform-badge{
      display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;
      font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;
    }
    .ap-status-badge{
      display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;
      font-size:10px;font-weight:600;
    }
  </style>
</head>
<body>

<!-- Background glows -->
<div class="bg-glow"></div>
<div class="bg-glow2"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="logo-badge">A</div>
      <div>
        <div style="font-size:14px;font-weight:700;letter-spacing:-.02em;">AdsGen</div>
        <div style="font-size:11px;color:var(--muted);">AI Creative Studio</div>
      </div>
    </div>
  </div>

  <!-- Client -->
  <div class="client-selector">
    <label class="label">Active Client</label>
    <div style="position:relative;">
      <select id="clientSelect" class="client-select">
        <option>Loading‚Ä¶</option>
      </select>
      <svg style="position:absolute;right:8px;top:50%;transform:translateY(-50%);pointer-events:none;width:14px;height:14px;color:var(--muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </div>
    <div class="client-actions">
      <button onclick="openNewClientModal()" class="btn btn-secondary btn-sm" style="flex:1;font-size:11px;">+ New</button>
      <button onclick="setDefaultClient()" class="btn btn-ghost btn-sm" style="flex:1;font-size:11px;">Set Default</button>
    </div>
  </div>

  <nav style="flex:1;overflow-y:auto;padding:8px 0;">
    <div class="nav-section-label">Workspace</div>
    <a class="nav-item active" data-section="generate" onclick="showSection('generate',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      Generate Ads
    </a>
    <a class="nav-item" data-section="history" onclick="showSection('history',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h8"/></svg>
      History Board
    </a>
    <a class="nav-item" data-section="campaign" onclick="showSection('campaign',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      Campaign Builder
    </a>

    <div class="nav-section-label">Brand</div>
    <a class="nav-item" data-section="brand" onclick="showSection('brand',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
      Brand Setup
    </a>
    <a class="nav-item" data-section="intelligence" onclick="showSection('intelligence',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
      Brand Intelligence
    </a>

    <div class="nav-section-label">Social</div>
    <a class="nav-item" data-section="autoposter" onclick="showSection('autoposter',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
      AutoPoster
    </a>

    <div class="nav-section-label">Library</div>
    <a class="nav-item" data-section="assets" onclick="showSection('assets',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
      Brand Assets
    </a>
    <a class="nav-item" data-section="templates" onclick="showSection('templates',this)">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
      Template Library
    </a>
  </nav>

  <div style="padding:8px;border-top:1px solid var(--border);">
    <!-- Theme toggle row -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 12px;margin-bottom:2px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span id="sideThemeIcon" style="font-size:15px;">üåô</span>
        <span id="sideThemeLabel" style="font-size:12px;font-weight:500;color:var(--muted2);">Dark Mode</span>
      </div>
      <label class="toggle" title="Switch theme" style="cursor:pointer;">
        <input type="checkbox" id="sideThemeToggle" onchange="applyTheme(!this.checked)"/>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
    </div>

    <a class="nav-item" data-section="settings" onclick="showSection('settings',this)" style="margin:0;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
      Settings & API Keys
    </a>
    <a href="/api/health" target="_blank" style="font-size:11px;color:var(--muted);text-decoration:none;display:flex;align-items:center;gap:6px;padding:8px 12px;">
      <div style="width:6px;height:6px;background:#34d399;border-radius:50%;box-shadow:0 0 6px #34d399;flex-shrink:0;"></div>
      System Online
    </a>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="main">

  <!-- Toast -->
  <div id="toastEl" style="display:none;"></div>

  <!-- ‚ïê‚ïê GENERATE ‚ïê‚ïê -->
  <div id="section-generate" class="section active">
    <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;">
      <div>
        <h1 class="page-title">Generate Static Ads</h1>
        <p class="page-sub">Create AI-powered ad creatives with FAL.ai</p>
      </div>
      <button onclick="openReverseModal()" class="btn btn-secondary" style="gap:6px;">
        <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        Reverse Engineer
      </button>
    </div>

    <div style="display:grid;grid-template-columns:320px 1fr;gap:20px;">
      <!-- Left panel -->
      <div style="display:flex;flex-direction:column;gap:14px;">

        <!-- Prompt -->
        <div class="card" style="padding:16px;">
          <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>‚úèÔ∏è Prompt</span>
          </div>
          <textarea id="genPrompt" class="input" rows="5" placeholder="Describe variations you want ‚Äî e.g. 'Summer sale 50% off', 'Free shipping today only', 'Buy 2 Get 1 Free'‚Ä¶"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button onclick="composePrompt()" class="btn btn-secondary btn-sm" style="flex:1;">‚ú® AI Compose</button>
            <button onclick="generateConcepts()" class="btn btn-secondary btn-sm" style="flex:1;">üí° Concepts</button>
          </div>
        </div>

        <!-- Images -->
        <div class="card" style="padding:16px;">
          <div class="section-title">üñºÔ∏è Reference Images</div>
          <p style="font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.4;">Upload a reference ad ‚Äî generated images will look nearly identical with only text/copy variations (quotes, discounts, CTAs).</p>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div>
              <label class="label">Style Reference (Ad Template)</label>
              <div id="refDropZone" class="drop-zone" onclick="document.getElementById('refImageInput').click()" ondragover="handleDragOver(event,'refDropZone')" ondrop="handleDrop(event,'refDropZone','refImagePreview','refImgEl')">
                <svg style="width:20px;height:20px;margin:0 auto 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Drop or click to upload
              </div>
              <input type="file" id="refImageInput" accept="image/*" class="hidden" onchange="previewImage(this,'refImagePreview','refImgEl')"/>
              <div id="refImagePreview" style="display:none;margin-top:6px;position:relative;">
                <img id="refImgEl" src="" style="width:100%;height:80px;object-fit:cover;border-radius:8px;"/>
                <button onclick="clearImage('refImagePreview','refImageUrlVal')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.7);color:#f87171;border:none;border-radius:4px;padding:2px 6px;font-size:11px;cursor:pointer;">‚úï</button>
              </div>
            </div>
            <div>
              <label class="label">Product Image</label>
              <div id="prodDropZone" class="drop-zone" onclick="document.getElementById('prodImageInput').click()">
                <svg style="width:20px;height:20px;margin:0 auto 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Drop or click to upload
              </div>
              <input type="file" id="prodImageInput" accept="image/*" class="hidden" onchange="previewImage(this,'prodImagePreview','prodImgEl')"/>
              <div id="prodImagePreview" style="display:none;margin-top:6px;position:relative;">
                <img id="prodImgEl" src="" style="width:100%;height:80px;object-fit:cover;border-radius:8px;"/>
                <button onclick="clearImage('prodImagePreview','prodImageUrlVal')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.7);color:#f87171;border:none;border-radius:4px;padding:2px 6px;font-size:11px;cursor:pointer;">‚úï</button>
              </div>
            </div>
            <div>
              <label class="label">Or paste URLs</label>
              <input type="url" id="refImageUrlVal" class="input" style="margin-bottom:6px;font-size:12px;" placeholder="Reference image URL‚Ä¶"/>
              <input type="url" id="prodImageUrlVal" class="input" style="font-size:12px;" placeholder="Product image URL‚Ä¶"/>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div class="card" style="padding:16px;">
          <div class="section-title">‚öôÔ∏è Settings</div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div>
              <label class="label">Output Size</label>
              <select id="genSize" class="input" style="font-size:12px;">
                <option value="1024x1024">1:1 Square (1024√ó1024)</option>
                <option value="1024x1792">9:16 Portrait (1024√ó1792)</option>
                <option value="1792x1024">16:9 Landscape (1792√ó1024)</option>
                <option value="1024x1280">4:5 Feed (1024√ó1280)</option>
              </select>
            </div>
            <div>
              <label class="label">Number of Images</label>
              <select id="genNumImages" class="input" style="font-size:12px;">
                <option value="1">1 image</option>
                <option value="2">2 images</option>
                <option value="3">3 images</option>
                <option value="4" selected>4 images</option>
                <option value="5">5 images</option>
                <option value="6">6 images</option>
                <option value="7">7 images</option>
                <option value="8">8 images</option>
                <option value="9">9 images</option>
                <option value="10">10 images</option>
              </select>
            </div>
            <div class="toggle-wrap">
              <label style="font-size:12px;color:var(--muted2);font-weight:500;">Apply Brand Kit</label>
              <label class="toggle">
                <input type="checkbox" id="useBrandKit"/>
                <div class="toggle-track"></div>
                <div class="toggle-thumb"></div>
              </label>
            </div>
            <div>
              <label class="label">Intelligence Profile</label>
              <select id="genProfileSelect" class="input" style="font-size:12px;">
                <option value="">None</option>
              </select>
            </div>
          </div>
        </div>

        <button id="genBtn" onclick="runGenerate()" class="btn btn-primary btn-lg" style="width:100%;">
          <svg style="width:16px;height:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Generate Ad
        </button>
      </div>

      <!-- Output -->
      <div id="genOutput">
        <div class="card" style="padding:60px 20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;border-style:dashed;min-height:400px;">
          <div style="width:56px;height:56px;border-radius:16px;background:var(--surface2);display:flex;align-items:center;justify-content:center;">
            <svg style="width:24px;height:24px;color:var(--muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          </div>
          <p style="color:var(--muted);font-size:14px;font-weight:500;">Your generated ads will appear here</p>
          <p style="color:var(--muted);font-size:12px;">Write a prompt and click Generate</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê HISTORY ‚ïê‚ïê -->
  <div id="section-history" class="section">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h1 class="page-title">History Board</h1>
        <p class="page-sub">All generated ads for this workspace</p>
      </div>
      <button onclick="loadHistory()" class="btn btn-secondary">
        <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        Refresh
      </button>
    </div>
    <div id="historyGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;">
      <div class="skeleton" style="height:240px;"></div>
      <div class="skeleton" style="height:240px;"></div>
      <div class="skeleton" style="height:240px;"></div>
      <div class="skeleton" style="height:240px;"></div>
    </div>
    <div style="text-align:center;margin-top:20px;">
      <button id="loadMoreBtn" onclick="loadMoreHistory()" class="btn btn-secondary" style="display:none;">Load More</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê CAMPAIGN ‚ïê‚ïê -->
  <div id="section-campaign" class="section">
    <div class="page-header">
      <h1 class="page-title">Campaign Builder</h1>
      <p class="page-sub">Plan and batch-generate ads from strategy profiles</p>
    </div>

    <!-- Steps -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:24px;overflow-x:auto;padding-bottom:4px;">
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="step1Circle" class="step-circle step-active">1</div>
        <span style="font-size:12px;color:var(--muted2);white-space:nowrap;">Reference</span>
      </div>
      <div style="color:var(--border2);font-size:18px;">‚Ä∫</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="step2Circle" class="step-circle step-pending">2</div>
        <span style="font-size:12px;color:var(--muted);white-space:nowrap;">Product</span>
      </div>
      <div style="color:var(--border2);font-size:18px;">‚Ä∫</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="step3Circle" class="step-circle step-pending">3</div>
        <span style="font-size:12px;color:var(--muted);white-space:nowrap;">Profiles</span>
      </div>
      <div style="color:var(--border2);font-size:18px;">‚Ä∫</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="step4Circle" class="step-circle step-pending">4</div>
        <span style="font-size:12px;color:var(--muted);white-space:nowrap;">Brief</span>
      </div>
      <div style="color:var(--border2);font-size:18px;">‚Ä∫</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="step5Circle" class="step-circle step-pending">5</div>
        <span style="font-size:12px;color:var(--muted);white-space:nowrap;">Plan</span>
      </div>
      <div style="color:var(--border2);font-size:18px;">‚Ä∫</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <div id="step6Circle" class="step-circle step-pending">6</div>
        <span style="font-size:12px;color:var(--muted);white-space:nowrap;">Generate</span>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div class="card" style="padding:16px;">
          <div class="section-title">‚ë† Style Reference Image</div>
          <input type="url" id="campRefUrl" class="input" style="font-size:13px;" placeholder="Paste reference image URL‚Ä¶" oninput="updateStep(1)"/>
        </div>
        <div class="card" style="padding:16px;">
          <div class="section-title">‚ë° Product Image</div>
          <input type="url" id="campProdUrl" class="input" style="font-size:13px;" placeholder="Paste product image URL‚Ä¶" oninput="updateStep(2)"/>
        </div>
        <div class="card" style="padding:16px;">
          <div class="section-title">‚ë¢ Intelligence Profiles</div>
          <div id="campProfileList" style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;">
            <p style="font-size:12px;color:var(--muted);">Loading profiles‚Ä¶</p>
          </div>
        </div>
        <div class="card" style="padding:16px;">
          <div class="section-title">‚ë£ Campaign Brief</div>
          <textarea id="campGoal" class="input" rows="3" style="margin-bottom:10px;font-size:13px;" placeholder="Campaign goal, e.g. Drive sign-ups for summer sale‚Ä¶"></textarea>
          <div class="grid-2">
            <div>
              <label class="label">Ads per profile</label>
              <select id="campAdsPerProfile" class="input" style="font-size:12px;">
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option>
              </select>
            </div>
            <div>
              <label class="label">Output size</label>
              <select id="campSize" class="input" style="font-size:12px;">
                <option value="1024x1024">1:1 Square</option>
                <option value="1024x1792">9:16 Portrait</option>
                <option value="1792x1024">16:9 Landscape</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:14px;">
        <div class="card" style="padding:16px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div class="section-title" style="margin:0;">‚ë§ Generation Plan</div>
            <button onclick="buildPlan()" class="btn btn-secondary btn-sm">Build Plan</button>
          </div>
          <div id="campPlanDisplay" style="font-size:12px;color:var(--muted);min-height:60px;">
            Plan will appear after clicking Build Plan‚Ä¶
          </div>
        </div>
        <div class="card" style="padding:16px;flex:1;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div class="section-title" style="margin:0;">‚ë• Generate</div>
            <button id="campGenBtn" onclick="runCampaign()" class="btn btn-primary btn-sm" disabled>‚ñ∂ Run Campaign</button>
          </div>
          <div id="campResults" style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto;">
            <p style="font-size:12px;color:var(--muted);">Results will appear here‚Ä¶</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê BRAND SETUP ‚ïê‚ïê -->
  <div id="section-brand" class="section">
    <div class="page-header">
      <h1 class="page-title">Brand Setup</h1>
      <p class="page-sub">Configure brand identity for consistent ad generation</p>
    </div>
    <div class="tab-bar">
      <button class="tab active" id="tab-kit" onclick="switchBrandTab('kit',this)">Brand Kit</button>
      <button class="tab" id="tab-assets-brand" onclick="switchBrandTab('assets-brand',this)">Brand Assets</button>
    </div>

    <div id="brandKitTab" style="display:grid;grid-template-columns:1fr 360px;gap:20px;">
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div class="card" style="padding:16px;">
          <div class="section-title">Brand Identity</div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div>
              <label class="label">Brand Name</label>
              <input type="text" id="bkName" class="input" placeholder="e.g. Acme Corp" oninput="scheduleBrandSave()"/>
            </div>
            <div>
              <label class="label">Brand Description / Tone</label>
              <textarea id="bkDesc" class="input" rows="3" placeholder="Describe your brand voice, values, and audience‚Ä¶" oninput="scheduleBrandSave()"></textarea>
            </div>
          </div>
        </div>
        <div class="card" style="padding:16px;">
          <div class="section-title">Typography</div>
          <div class="grid-2">
            <div>
              <label class="label">Primary Font</label>
              <input type="text" id="bkFontPrimary" class="input" value="Inter" oninput="scheduleBrandSave()"/>
            </div>
            <div>
              <label class="label">Secondary Font</label>
              <input type="text" id="bkFontSecondary" class="input" value="Georgia" oninput="scheduleBrandSave()"/>
            </div>
          </div>
        </div>
        <div class="card" style="padding:16px;">
          <div class="section-title">Color Palette</div>
          <div class="grid-3">
            <div>
              <label class="label">Primary</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="color" id="bkColorPrimary" value="#000000" class="color-swatch" oninput="updateColorInput('bkColorPrimary','bkColorPrimaryHex');scheduleBrandSave()"/>
                <input type="text" id="bkColorPrimaryHex" class="input" style="font-size:11px;" value="#000000" oninput="syncColorPicker('bkColorPrimaryHex','bkColorPrimary');scheduleBrandSave()"/>
              </div>
            </div>
            <div>
              <label class="label">Secondary</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="color" id="bkColorSecondary" value="#ffffff" class="color-swatch" oninput="updateColorInput('bkColorSecondary','bkColorSecondaryHex');scheduleBrandSave()"/>
                <input type="text" id="bkColorSecondaryHex" class="input" style="font-size:11px;" value="#ffffff" oninput="syncColorPicker('bkColorSecondaryHex','bkColorSecondary');scheduleBrandSave()"/>
              </div>
            </div>
            <div>
              <label class="label">Accent</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="color" id="bkColorAccent" value="#ff6600" class="color-swatch" oninput="updateColorInput('bkColorAccent','bkColorAccentHex');scheduleBrandSave()"/>
                <input type="text" id="bkColorAccentHex" class="input" style="font-size:11px;" value="#ff6600" oninput="syncColorPicker('bkColorAccentHex','bkColorAccent');scheduleBrandSave()"/>
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="padding:16px;">
          <div class="section-title">Logos</div>
          <div class="grid-2">
            <div>
              <label class="label">Dark Logo (on light bg)</label>
              <div class="drop-zone" onclick="document.getElementById('logoDarkInput').click()">
                <img id="logoDarkPreview" style="width:100%;height:36px;object-fit:contain;display:none;margin-bottom:4px;"/>
                <span style="font-size:11px;">Click to upload</span>
              </div>
              <input type="file" id="logoDarkInput" accept="image/*" style="display:none;" onchange="uploadLogo(this,'dark')"/>
            </div>
            <div>
              <label class="label">Light Logo (on dark bg)</label>
              <div class="drop-zone" onclick="document.getElementById('logoLightInput').click()">
                <img id="logoLightPreview" style="width:100%;height:36px;object-fit:contain;display:none;margin-bottom:4px;"/>
                <span style="font-size:11px;">Click to upload</span>
              </div>
              <input type="file" id="logoLightInput" accept="image/*" style="display:none;" onchange="uploadLogo(this,'light')"/>
            </div>
          </div>
        </div>
        <div id="brandSaveStatus" style="font-size:11px;color:var(--muted);text-align:right;display:none;">Saving‚Ä¶</div>
      </div>

      <!-- Brand Preview -->
      <div>
        <div class="card" style="padding:16px;position:sticky;top:20px;">
          <div class="section-title">Live Preview</div>
          <div id="brandPreview" style="border-radius:12px;overflow:hidden;min-height:220px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;background:#000;transition:background .3s;">
            <img id="previewLogo" src="" style="height:40px;object-fit:contain;margin-bottom:16px;display:none;"/>
            <h2 id="previewBrandName" style="font-size:22px;font-weight:800;color:white;margin-bottom:8px;text-align:center;">Your Brand</h2>
            <p id="previewDesc" style="font-size:12px;color:rgba(255,255,255,.5);text-align:center;max-width:200px;line-height:1.5;"></p>
            <div style="display:flex;gap:8px;margin-top:16px;">
              <div id="previewPrimary" style="width:28px;height:28px;border-radius:50%;box-shadow:0 0 8px rgba(0,0,0,.5);"></div>
              <div id="previewSecondary" style="width:28px;height:28px;border-radius:50%;box-shadow:0 0 8px rgba(0,0,0,.5);"></div>
              <div id="previewAccent" style="width:28px;height:28px;border-radius:50%;box-shadow:0 0 8px rgba(0,0,0,.5);"></div>
            </div>
          </div>
          <div style="margin-top:12px;display:grid;gap:6px;">
            <div style="display:flex;justify-content:space-between;font-size:12px;">
              <span style="color:var(--muted);">Primary font</span>
              <span id="previewFont" style="color:var(--muted2);">Inter</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:12px;">
              <span style="color:var(--muted);">Secondary font</span>
              <span id="previewFont2" style="color:var(--muted2);">Georgia</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="brandAssetsTab" style="display:none;">
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Upload and manage brand image assets in the dedicated library.</p>
      <button onclick="showSection('assets',document.querySelector('[data-section=assets]'))" class="btn btn-primary">Go to Brand Assets ‚Üí</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTELLIGENCE ‚ïê‚ïê -->
  <div id="section-intelligence" class="section">
    <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;">
      <div>
        <h1 class="page-title">Brand Intelligence</h1>
        <p class="page-sub">Audience personas, pain points, and creative angles</p>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="openGenerateIntelligenceModal()" class="btn btn-secondary">‚ú® AI Generate</button>
        <button onclick="openAddProfileModal()" class="btn btn-primary">+ Add Profile</button>
      </div>
    </div>
    <div id="intelligenceList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;">
      <div class="skeleton" style="height:180px;"></div>
      <div class="skeleton" style="height:180px;"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ASSETS ‚ïê‚ïê -->
  <div id="section-assets" class="section">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h1 class="page-title">Brand Assets</h1>
        <p class="page-sub">Product images, lifestyle shots, packaging</p>
      </div>
      <label class="btn btn-primary" style="cursor:pointer;">
        <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
        Upload Assets
        <input type="file" id="assetFileInput" accept="image/*" multiple style="display:none;" onchange="uploadAssets(this)"/>
      </label>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;">
      <button onclick="filterAssets('')" class="btn btn-secondary btn-sm" id="filterAll">All</button>
      <button onclick="filterAssets('product_image')" class="btn btn-ghost btn-sm">Product Images</button>
      <button onclick="filterAssets('packaging')" class="btn btn-ghost btn-sm">Packaging</button>
      <button onclick="filterAssets('lifestyle')" class="btn btn-ghost btn-sm">Lifestyle</button>
      <button onclick="filterAssets('logo')" class="btn btn-ghost btn-sm">Logos</button>
      <button onclick="filterAssets('other')" class="btn btn-ghost btn-sm">Other</button>
    </div>
    <div id="assetsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;">
      <div class="skeleton" style="height:140px;"></div>
      <div class="skeleton" style="height:140px;"></div>
      <div class="skeleton" style="height:140px;"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TEMPLATES ‚ïê‚ïê -->
  <div id="section-templates" class="section">
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h1 class="page-title">Template Library</h1>
        <p class="page-sub">Winning creative references and starting points</p>
      </div>
      <label class="btn btn-primary" style="cursor:pointer;">
        + Upload Template
        <input type="file" id="templateFileInput" accept="image/*" style="display:none;" onchange="uploadTemplate(this)"/>
      </label>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <input type="text" id="templateSearch" class="input" style="max-width:220px;font-size:13px;" placeholder="Search templates‚Ä¶" oninput="loadTemplates()"/>
      <select id="templateCategory" class="input" style="max-width:160px;font-size:13px;" onchange="loadTemplates()">
        <option value="">All Categories</option>
        <option value="general">General</option>
        <option value="generated">Generated</option>
        <option value="product">Product</option>
        <option value="lifestyle">Lifestyle</option>
        <option value="seasonal">Seasonal</option>
      </select>
    </div>
    <div id="templatesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;">
      <div class="skeleton" style="height:220px;"></div>
      <div class="skeleton" style="height:220px;"></div>
      <div class="skeleton" style="height:220px;"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê AUTOPOSTER ‚ïê‚ïê -->
  <div id="section-autoposter" class="section">
    <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;">
      <div>
        <h1 class="page-title">AutoPoster</h1>
        <p class="page-sub">Create and publish content across social platforms</p>
      </div>
    </div>

    <!-- Tabs -->
    <div style="display:flex;gap:4px;margin-bottom:24px;background:var(--surface);border-radius:10px;padding:4px;border:1px solid var(--border);">
      <button class="ap-tab active" onclick="switchAPTab('upload',this)">Manual Upload</button>
      <button class="ap-tab" onclick="switchAPTab('aicreate',this)">AI Create Post</button>
      <button class="ap-tab" onclick="switchAPTab('queue',this)">Post Queue</button>
    </div>

    <!-- ‚îÄ‚îÄ Tab 1: Manual Upload ‚îÄ‚îÄ -->
    <div id="ap-tab-upload" class="ap-tab-content active">
      <!-- Video Platforms -->
      <div class="card" style="padding:20px;margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:20px;">üé¨</span>
          <div>
            <div style="font-size:15px;font-weight:600;">Video Platforms</div>
            <div style="font-size:12px;color:var(--muted);">Instagram Reels ¬∑ TikTok ¬∑ YouTube Shorts</div>
          </div>
        </div>
        <div id="apVideoDropZone" class="drop-zone" style="border:2px dashed var(--border2);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;"
             ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='rgba(99,102,241,.05)'"
             ondragleave="this.style.borderColor='var(--border2)';this.style.background='transparent'"
             ondrop="event.preventDefault();this.style.borderColor='var(--border2)';this.style.background='transparent';handleAPVideoUpload(event.dataTransfer.files[0])"
             onclick="document.getElementById('apVideoInput').click()">
          <svg style="width:40px;height:40px;color:var(--muted);margin:0 auto 10px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <div style="font-size:13px;font-weight:500;color:var(--muted2);">Drag & drop a video or click to browse</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">MP4, MOV, WebM ‚Äî up to 100MB</div>
        </div>
        <input type="file" id="apVideoInput" accept="video/*" style="display:none" onchange="handleAPVideoUpload(this.files[0])"/>
        <textarea id="apVideoDesc" class="input" rows="2" placeholder="Describe your video content (optional ‚Äî helps AI generate better metadata)..." style="margin-top:12px;"></textarea>
        <button id="apVideoUploadBtn" onclick="uploadAPVideo()" class="btn btn-primary" style="margin-top:10px;width:100%;display:none;">Upload & Generate Metadata</button>
      </div>

      <!-- Image Platforms -->
      <div class="card" style="padding:20px;margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:20px;">üñºÔ∏è</span>
          <div>
            <div style="font-size:15px;font-weight:600;">Image Platforms</div>
            <div style="font-size:12px;color:var(--muted);">LinkedIn ¬∑ Facebook ¬∑ Pinterest</div>
          </div>
        </div>
        <div id="apImageDropZone" class="drop-zone" style="border:2px dashed var(--border2);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;"
             ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='rgba(99,102,241,.05)'"
             ondragleave="this.style.borderColor='var(--border2)';this.style.background='transparent'"
             ondrop="event.preventDefault();this.style.borderColor='var(--border2)';this.style.background='transparent';handleAPImageUpload(event.dataTransfer.files[0])"
             onclick="document.getElementById('apImageInput').click()">
          <svg style="width:40px;height:40px;color:var(--muted);margin:0 auto 10px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <div style="font-size:13px;font-weight:500;color:var(--muted2);">Drag & drop an image or click to browse</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">JPG, PNG, WebP ‚Äî up to 100MB</div>
        </div>
        <input type="file" id="apImageInput" accept="image/*" style="display:none" onchange="handleAPImageUpload(this.files[0])"/>
        <textarea id="apImageDesc" class="input" rows="2" placeholder="Describe your image content (optional ‚Äî helps AI generate better metadata)..." style="margin-top:12px;"></textarea>
        <button id="apImageUploadBtn" onclick="uploadAPImage()" class="btn btn-primary" style="margin-top:10px;width:100%;display:none;">Upload & Generate Metadata</button>
      </div>

      <!-- Upload results -->
      <div id="apUploadResults"></div>
    </div>

    <!-- ‚îÄ‚îÄ Tab 2: AI Create Post ‚îÄ‚îÄ -->
    <div id="ap-tab-aicreate" class="ap-tab-content">
      <div class="card" style="padding:24px;margin-bottom:20px;">
        <div style="font-size:15px;font-weight:600;margin-bottom:16px;">Describe your post idea</div>
        <textarea id="apAIDesc" class="input" rows="3" placeholder="e.g. Announce our summer sale with 30% off all products, bright and energetic visuals..." style="margin-bottom:14px;"></textarea>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;">
          <div>
            <label class="label">Tone</label>
            <select id="apAITone" class="input">
              <option value="Professional">Professional</option>
              <option value="Casual">Casual</option>
              <option value="Exciting">Exciting</option>
              <option value="Inspirational">Inspirational</option>
              <option value="Informative">Informative</option>
            </select>
          </div>
          <div>
            <label class="label">Use Brand Kit</label>
            <div style="display:flex;align-items:center;gap:10px;padding-top:8px;">
              <label class="toggle" style="cursor:pointer;">
                <input type="checkbox" id="apAIBrandKit"/>
                <div class="toggle-track"></div>
                <div class="toggle-thumb"></div>
              </label>
              <span style="font-size:12px;color:var(--muted2);">Apply brand colors & tone</span>
            </div>
          </div>
        </div>

        <label class="label">Platforms</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
          <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;">
            <input type="checkbox" class="ap-platform-cb" value="instagram" checked/> Instagram
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;">
            <input type="checkbox" class="ap-platform-cb" value="tiktok" checked/> TikTok
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;">
            <input type="checkbox" class="ap-platform-cb" value="youtube" checked/> YouTube
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;">
            <input type="checkbox" class="ap-platform-cb" value="linkedin" checked/> LinkedIn
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;">
            <input type="checkbox" class="ap-platform-cb" value="facebook" checked/> Facebook
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;">
            <input type="checkbox" class="ap-platform-cb" value="pinterest" checked/> Pinterest
          </label>
        </div>

        <button onclick="runAICreatePost()" class="btn btn-primary" style="width:100%;gap:8px;">
          <svg style="width:16px;height:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Auto Create Post
        </button>
      </div>

      <div id="apAIResults"></div>
    </div>

    <!-- ‚îÄ‚îÄ Tab 3: Post Queue ‚îÄ‚îÄ -->
    <div id="ap-tab-queue" class="ap-tab-content">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
        <button class="ap-filter active" onclick="filterAPQueue('all',this)">All</button>
        <button class="ap-filter" onclick="filterAPQueue('draft',this)">Drafts</button>
        <button class="ap-filter" onclick="filterAPQueue('scheduled',this)">Scheduled</button>
        <button class="ap-filter" onclick="filterAPQueue('posted',this)">Posted</button>
        <button class="ap-filter" onclick="filterAPQueue('failed',this)">Failed</button>
        <button onclick="loadAPQueue()" class="btn btn-secondary btn-sm" style="margin-left:auto;">Refresh</button>
      </div>
      <div id="apQueueGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;">
        <div style="text-align:center;padding:40px;color:var(--muted);font-size:13px;">No posts yet. Upload content or use AI Create Post.</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SETTINGS ‚ïê‚ïê -->
  <div id="section-settings" class="section">
    <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;">
      <div>
        <h1 class="page-title">Settings & API Keys</h1>
        <p class="page-sub">Configure API providers for image generation and AI features</p>
      </div>
      <!-- Day / Night toggle -->
      <div style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:12px;background:var(--surface2);border:1px solid var(--border);">
        <span id="themeIconDay" style="font-size:16px;opacity:.5;">‚òÄÔ∏è</span>
        <label class="toggle" title="Toggle light/dark theme" style="cursor:pointer;">
          <input type="checkbox" id="themeToggle" onchange="applyTheme(this.checked)"/>
          <div class="toggle-track" style="width:44px;height:24px;"></div>
          <div class="toggle-thumb" style="width:16px;height:16px;top:4px;left:4px;"></div>
        </label>
        <span id="themeIconNight" style="font-size:16px;">üåô</span>
        <span id="themeLabel" style="font-size:12px;font-weight:500;color:var(--muted2);min-width:36px;">Dark</span>
      </div>
    </div>

    <!-- Image Generation -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">

      <!-- FAL.ai -->
      <div class="card" style="padding:20px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#f97316,#ea580c);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:14px;">F</div>
          <div>
            <div style="font-size:14px;font-weight:600;">FAL.ai</div>
            <div style="font-size:12px;color:var(--muted);">Primary image generator ¬∑ flux/schnell</div>
          </div>
          <div id="falStatus" style="margin-left:auto;"></div>
        </div>
        <label class="label">API Key</label>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input type="password" id="falKeyInput" class="input" placeholder="Enter FAL API key‚Ä¶" autocomplete="new-password"/>
          <button onclick="toggleVisible('falKeyInput')" class="btn btn-secondary btn-sm" style="flex-shrink:0;">üëÅ</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="saveKey('fal_key','falKeyInput','falStatus')" class="btn btn-primary btn-sm" style="flex:1;">Save Key</button>
          <button onclick="removeKey('fal_key','falStatus')" class="btn btn-danger btn-sm">Remove</button>
        </div>
        <p style="font-size:11px;color:var(--muted);margin-top:10px;">Get your key at <a href="https://fal.ai/dashboard/keys" target="_blank" style="color:#a5b4fc;">fal.ai/dashboard/keys</a></p>
      </div>

      <!-- Leonardo.ai -->
      <div class="card" style="padding:20px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#a855f7,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:14px;">L</div>
          <div>
            <div style="font-size:14px;font-weight:600;">Leonardo.ai</div>
            <div style="font-size:12px;color:var(--muted);">Fallback image generator</div>
          </div>
          <div id="leonardoStatus" style="margin-left:auto;"></div>
        </div>
        <label class="label">API Key</label>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input type="password" id="leonardoKeyInput" class="input" placeholder="Enter Leonardo API key‚Ä¶" autocomplete="new-password"/>
          <button onclick="toggleVisible('leonardoKeyInput')" class="btn btn-secondary btn-sm" style="flex-shrink:0;">üëÅ</button>
        </div>
        <label class="label" style="margin-top:8px;">Model ID (optional)</label>
        <input type="text" id="leonardoModelInput" class="input" style="margin-bottom:10px;" placeholder="b24e16ff-06e3-43eb-8d33-4416c2d75876"/>
        <div style="display:flex;gap:8px;">
          <button onclick="saveLeonardoKeys()" class="btn btn-primary btn-sm" style="flex:1;">Save</button>
          <button onclick="removeKey('leonardo_api_key','leonardoStatus')" class="btn btn-danger btn-sm">Remove</button>
        </div>
        <p style="font-size:11px;color:var(--muted);margin-top:10px;">Get your key at <a href="https://app.leonardo.ai/settings/api-keys" target="_blank" style="color:#a5b4fc;">app.leonardo.ai</a></p>
      </div>

    </div>

    <!-- AI / LLM -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">

      <!-- Gemini -->
      <div class="card" style="padding:20px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#4285f4,#34a853);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:14px;">G</div>
          <div>
            <div style="font-size:14px;font-weight:600;">Google Gemini</div>
            <div style="font-size:12px;color:var(--muted);">Prompt composition & AI features</div>
          </div>
          <div id="geminiStatus" style="margin-left:auto;"></div>
        </div>
        <label class="label">API Key</label>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input type="password" id="geminiKeyInput" class="input" placeholder="Enter Gemini API key‚Ä¶" autocomplete="new-password"/>
          <button onclick="toggleVisible('geminiKeyInput')" class="btn btn-secondary btn-sm" style="flex-shrink:0;">üëÅ</button>
        </div>
        <label class="label" style="margin-top:8px;">Model</label>
        <select id="geminiModelInput" class="input" style="margin-bottom:10px;">
          <optgroup label="Gemini 2.5">
            <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview (most capable)</option>
          </optgroup>
          <optgroup label="Gemini 2.0">
            <option value="gemini-2.0-flash" selected>gemini-2.0-flash (recommended)</option>
            <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite (fast &amp; cheap)</option>
            <option value="gemini-2.0-pro-exp">gemini-2.0-pro-exp (experimental)</option>
            <option value="gemini-2.0-flash-thinking-exp">gemini-2.0-flash-thinking (reasoning)</option>
          </optgroup>
          <optgroup label="Gemini 1.5">
            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
            <option value="gemini-1.5-flash-8b">gemini-1.5-flash-8b (nano/smallest)</option>
            <option value="gemini-1.5-pro">gemini-1.5-pro</option>
          </optgroup>
        </select>
        <div style="display:flex;gap:8px;">
          <button onclick="saveGeminiKeys()" class="btn btn-primary btn-sm" style="flex:1;">Save</button>
          <button onclick="removeKey('gemini_api_key','geminiStatus')" class="btn btn-danger btn-sm">Remove</button>
        </div>
        <p style="font-size:11px;color:var(--muted);margin-top:10px;">Get your key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#a5b4fc;">aistudio.google.com</a></p>
      </div>

      <!-- Mistral AI -->
      <div class="card" style="padding:20px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#f97316,#f59e0b);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:14px;">M</div>
          <div>
            <div style="font-size:14px;font-weight:600;">Mistral AI</div>
            <div style="font-size:12px;color:var(--muted);">LLM fallback when Gemini fails</div>
          </div>
          <div id="mistralStatus" style="margin-left:auto;"></div>
        </div>
        <label class="label">API Key</label>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input type="password" id="mistralKeyInput" class="input" placeholder="Enter Mistral API key‚Ä¶" autocomplete="new-password"/>
          <button onclick="toggleVisible('mistralKeyInput')" class="btn btn-secondary btn-sm" style="flex-shrink:0;">üëÅ</button>
        </div>
        <label class="label" style="margin-top:8px;">Model</label>
        <select id="mistralModelInput" class="input" style="margin-bottom:10px;">
          <optgroup label="Ministral (Nano)">
            <option value="ministral-3b-latest">ministral-3b (nano, fastest &amp; cheapest)</option>
            <option value="ministral-8b-latest">ministral-8b (fast, efficient)</option>
          </optgroup>
          <optgroup label="Mistral">
            <option value="mistral-small-latest" selected>mistral-small-latest (recommended)</option>
            <option value="mistral-large-latest">mistral-large-latest (most capable)</option>
          </optgroup>
          <optgroup label="Open / Nemo">
            <option value="open-mistral-nemo">open-mistral-nemo (12B, open source)</option>
            <option value="open-mistral-7b">open-mistral-7b (7B, open source)</option>
          </optgroup>
        </select>
        <div style="display:flex;gap:8px;">
          <button onclick="saveMistralKeys()" class="btn btn-primary btn-sm" style="flex:1;">Save</button>
          <button onclick="removeKey('mistral_api_key','mistralStatus')" class="btn btn-danger btn-sm">Remove</button>
        </div>
        <p style="font-size:11px;color:var(--muted);margin-top:10px;">Get your key at <a href="https://console.mistral.ai/api-keys/" target="_blank" style="color:#a5b4fc;">console.mistral.ai</a></p>
      </div>

    </div>

    <!-- Priority Info -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">

      <!-- Image Generation Priority -->
      <div class="card" style="padding:20px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:12px;">üñºÔ∏è Image Generation Priority</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
            <span style="font-size:18px;">1Ô∏è‚É£</span>
            <div>
              <div style="font-size:13px;font-weight:500;">FAL.ai (Primary)</div>
              <div style="font-size:11px;color:var(--muted);">Tried first on every generation</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:4px;color:var(--muted);font-size:12px;padding-left:12px;">‚Üì fails automatically</div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
            <span style="font-size:18px;">2Ô∏è‚É£</span>
            <div>
              <div style="font-size:13px;font-weight:500;">Leonardo.ai (Fallback)</div>
              <div style="font-size:11px;color:var(--muted);">Used automatically when FAL fails</div>
            </div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6;padding:10px;background:rgba(99,102,241,.07);border-radius:8px;border:1px solid rgba(99,102,241,.15);">
          üí° You need <strong style="color:var(--muted2);">one</strong> image API. Set both for automatic failover resilience.
        </div>
      </div>

      <!-- LLM Priority -->
      <div class="card" style="padding:20px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:12px;">ü§ñ AI / LLM Priority</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
            <span style="font-size:18px;">1Ô∏è‚É£</span>
            <div>
              <div style="font-size:13px;font-weight:500;">Google Gemini (Primary)</div>
              <div style="font-size:11px;color:var(--muted);">Prompt composition, intelligence & campaigns</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:4px;color:var(--muted);font-size:12px;padding-left:12px;">‚Üì fails automatically</div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
            <span style="font-size:18px;">2Ô∏è‚É£</span>
            <div>
              <div style="font-size:13px;font-weight:500;">Mistral AI (Fallback)</div>
              <div style="font-size:11px;color:var(--muted);">Used automatically when Gemini fails</div>
            </div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6;padding:10px;background:rgba(249,115,22,.07);border-radius:8px;border:1px solid rgba(249,115,22,.15);">
          üí° You need <strong style="color:var(--muted2);">one</strong> LLM API. Set both for automatic failover resilience.
        </div>
      </div>

    </div>

    <!-- Current Status -->
    <div class="card" style="padding:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="font-size:14px;font-weight:600;">API Key Status</div>
        <button onclick="loadSettings()" class="btn btn-secondary btn-sm">‚Üª Refresh</button>
      </div>
      <div id="settingsStatusGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">
        <div class="skeleton" style="height:60px;"></div>
        <div class="skeleton" style="height:60px;"></div>
        <div class="skeleton" style="height:60px;"></div>
      </div>
    </div>

    <!-- Social Platform Connections -->
    <div style="margin-top:20px;">
      <div style="font-size:16px;font-weight:700;margin-bottom:16px;">Social Platform Connections</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;" id="socialConnectionsGrid">
      </div>
    </div>

  </div>

</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- New Client -->
<div id="newClientModal" class="modal-backdrop">
  <div class="modal" style="width:380px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <h2 style="font-size:16px;font-weight:700;">New Client</h2>
      <button onclick="closeModal('newClientModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <label class="label">Client Name</label>
    <input type="text" id="newClientName" class="input" style="margin-bottom:16px;" placeholder="e.g. Acme Corp"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button onclick="closeModal('newClientModal')" class="btn btn-secondary">Cancel</button>
      <button onclick="createClient()" class="btn btn-primary">Create Client</button>
    </div>
  </div>
</div>

<!-- Add Profile -->
<div id="addProfileModal" class="modal-backdrop">
  <div class="modal" style="width:520px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <h2 style="font-size:16px;font-weight:700;">Add Intelligence Profile</h2>
      <button onclick="closeModal('addProfileModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div><label class="label">Persona *</label><input type="text" id="profPersona" class="input" placeholder="e.g. Health-conscious millennial moms"/></div>
      <div><label class="label">Pain Point</label><input type="text" id="profPain" class="input" placeholder="Core frustration they face"/></div>
      <div><label class="label">Marketing Angle</label><input type="text" id="profAngle" class="input" placeholder="Angle that resonates with them"/></div>
      <div><label class="label">Visual Direction</label><input type="text" id="profVisual" class="input" placeholder="Colors, mood, imagery style"/></div>
      <div><label class="label">Emotion</label><input type="text" id="profEmotion" class="input" placeholder="Primary emotion to evoke"/></div>
      <div><label class="label">Copy Hook</label><input type="text" id="profHook" class="input" placeholder="Opening line for ads"/></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
      <button onclick="closeModal('addProfileModal')" class="btn btn-secondary">Cancel</button>
      <button onclick="saveProfile()" class="btn btn-primary">Save Profile</button>
    </div>
  </div>
</div>

<!-- Edit Profile -->
<div id="editProfileModal" class="modal-backdrop">
  <div class="modal" style="width:520px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <h2 style="font-size:16px;font-weight:700;">Edit Profile</h2>
      <button onclick="closeModal('editProfileModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <input type="hidden" id="editProfileId"/>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div><label class="label">Persona</label><input type="text" id="editProfPersona" class="input"/></div>
      <div><label class="label">Pain Point</label><input type="text" id="editProfPain" class="input"/></div>
      <div><label class="label">Angle</label><input type="text" id="editProfAngle" class="input"/></div>
      <div><label class="label">Visual Direction</label><input type="text" id="editProfVisual" class="input"/></div>
      <div><label class="label">Emotion</label><input type="text" id="editProfEmotion" class="input"/></div>
      <div><label class="label">Copy Hook</label><input type="text" id="editProfHook" class="input"/></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
      <button onclick="closeModal('editProfileModal')" class="btn btn-secondary">Cancel</button>
      <button onclick="updateProfile()" class="btn btn-primary">Save Changes</button>
    </div>
  </div>
</div>

<!-- Generate Intelligence -->
<div id="generateIntelModal" class="modal-backdrop">
  <div class="modal" style="width:480px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <h2 style="font-size:16px;font-weight:700;">‚ú® AI Generate Profiles</h2>
      <button onclick="closeModal('generateIntelModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Gemini will generate audience profiles based on your brand kit.</p>
    <label class="label">Research context (optional)</label>
    <textarea id="intelResearch" class="input" rows="4" style="margin-bottom:12px;" placeholder="Paste competitor analysis, market research, or notes‚Ä¶"></textarea>
    <label class="label">Number of profiles</label>
    <select id="intelNumProfiles" class="input" style="margin-bottom:16px;">
      <option value="2">2</option><option value="3" selected>3</option><option value="5">5</option>
    </select>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button onclick="closeModal('generateIntelModal')" class="btn btn-secondary">Cancel</button>
      <button onclick="generateIntelligence()" class="btn btn-primary">‚ú® Generate Now</button>
    </div>
  </div>
</div>

<!-- Reverse Engineer -->
<div id="reverseModal" class="modal-backdrop">
  <div class="modal" style="width:620px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <h2 style="font-size:16px;font-weight:700;">üîç Reverse Engineer Ad</h2>
      <button onclick="closeModal('reverseModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Extract the style prompt and generate variations from a winning ad.</p>
    <label class="label">Ad Image URL *</label>
    <input type="url" id="reverseImageUrl" class="input" style="margin-bottom:10px;" placeholder="https://‚Ä¶"/>
    <label class="label">Campaign context (optional)</label>
    <input type="text" id="reverseCampaignGoal" class="input" style="margin-bottom:14px;" placeholder="e.g. Drive summer sale conversions"/>
    <button onclick="runReverse()" class="btn btn-primary" style="width:100%;margin-bottom:16px;">üîç Analyze Ad</button>
    <div id="reverseResults" style="display:none;display:flex;flex-direction:column;gap:12px;">
      <div class="card" style="padding:12px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Style Prompt</div>
        <p id="reverseStylePrompt" style="font-size:13px;line-height:1.5;"></p>
        <button onclick="applyReversePrompt()" class="btn btn-secondary btn-sm" style="margin-top:8px;">Apply to Generator ‚Üí</button>
      </div>
      <div class="card" style="padding:12px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Copy Skeleton</div>
        <p id="reverseCopySkeleton" style="font-size:13px;line-height:1.5;"></p>
      </div>
      <div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Variant Prompts</div>
        <div id="reverseVariants" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Gen Detail -->
<div id="genDetailModal" class="modal-backdrop">
  <div class="modal" style="width:600px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h2 style="font-size:16px;font-weight:700;">Generation Details</h2>
      <button onclick="closeModal('genDetailModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <div id="genDetailContent"></div>
  </div>
</div>

<!-- Asset Category -->
<div id="assetCategoryModal" class="modal-backdrop">
  <div class="modal" style="width:340px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h2 style="font-size:15px;font-weight:700;">Categorize Assets</h2>
      <button onclick="closeModal('assetCategoryModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px;">Assign a category to the uploaded files:</p>
    <select id="assetCategorySelect" class="input" style="margin-bottom:16px;">
      <option value="other">Other</option>
      <option value="product_image">Product Image</option>
      <option value="packaging">Packaging</option>
      <option value="lifestyle">Lifestyle</option>
      <option value="logo">Logo</option>
    </select>
    <div style="display:flex;gap:8px;">
      <button onclick="closeModal('assetCategoryModal')" class="btn btn-secondary" style="flex:1;">Skip</button>
      <button onclick="applyAssetCategory()" class="btn btn-primary" style="flex:1;">Apply</button>
    </div>
  </div>
</div>

<!-- Concepts -->
<div id="conceptsModal" class="modal-backdrop">
  <div class="modal" style="width:580px;padding:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h2 style="font-size:16px;font-weight:700;">üí° Concept Directions</h2>
      <button onclick="closeModal('conceptsModal')" class="btn btn-ghost btn-icon" style="color:var(--muted);">‚úï</button>
    </div>
    <div id="conceptsList" style="display:flex;flex-direction:column;gap:10px;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
let currentClientId=null,historyOffset=0,historyTotal=0,brandSaveTimer=null,pendingAssetIds=[],campaignPlan=[],reverseData=null;

function downloadImage(url, filename) {
  const a = document.createElement('a');
  a.href = '/api/download-image?url=' + encodeURIComponent(url);
  a.download = filename || 'generated-ad.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

document.addEventListener('DOMContentLoaded',async()=>{
  await loadClients();
  await loadProfilesForSelect();
});

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function showSection(name,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('section-'+name).classList.add('active');
  if(el)el.classList.add('active');
  if(name==='settings'){loadSettings();loadSocialConnections();return;}
  if(name==='autoposter'){loadAPQueue();return;}
  if(!currentClientId){toast('Please create or select a client first','error');return;}
  if(name==='history')loadHistory();
  if(name==='brand')loadBrandKit();
  if(name==='intelligence')loadIntelligence();
  if(name==='assets')loadAssets();
  if(name==='templates')loadTemplates();
  if(name==='campaign')loadCampaignProfiles();
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg,type='success'){
  const el=document.getElementById('toastEl');
  el.className=`toast toast-${type}`;
  el.innerHTML=`<span style="font-size:15px;">${type==='success'?'‚úì':type==='error'?'‚úï':'‚Ñπ'}</span><span style="flex:1;">${msg}</span>`;
  el.style.display='flex';
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.style.display='none',3500);
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-backdrop').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
async function api(path,opts={}){
  const res=await fetch(path,{headers:{'Content-Type':'application/json'},...opts});
  const data=await res.json().catch(()=>({}));
  if(!res.ok)throw new Error(data.error||`HTTP ${res.status}`);
  return data;
}

// ‚îÄ‚îÄ Clients ‚îÄ‚îÄ
async function loadClients(){
  try{
    const{clients}=await api('/api/clients');
    const sel=document.getElementById('clientSelect');
    sel.innerHTML=clients.map(c=>`<option value="${c.id}" ${c.is_default?'selected':''}>${c.name}${c.is_default?' ‚úì':''}</option>`).join('');
    const def=clients.find(c=>c.is_default)||clients[0];
    if(def){currentClientId=def.id;sel.value=def.id;}
    sel.onchange=()=>{currentClientId=parseInt(sel.value);};
  }catch(e){toast(e.message,'error');}
}
function openNewClientModal(){openModal('newClientModal');document.getElementById('newClientName').focus();}
async function createClient(){
  const name=document.getElementById('newClientName').value.trim();
  if(!name)return;
  try{
    await api('/api/clients',{method:'POST',body:JSON.stringify({name})});
    closeModal('newClientModal');
    document.getElementById('newClientName').value='';
    await loadClients();
    toast('Client created');
  }catch(e){toast(e.message,'error');}
}
async function setDefaultClient(){
  if(!currentClientId)return;
  try{await api(`/api/clients/${currentClientId}/set-default`,{method:'POST'});await loadClients();toast('Default client updated');}
  catch(e){toast(e.message,'error');}
}

// ‚îÄ‚îÄ Brand Kit ‚îÄ‚îÄ
async function loadBrandKit(){
  try{
    const{brandKit}=await api(`/api/brand-kit?clientId=${currentClientId}`);
    if(brandKit){
      document.getElementById('bkName').value=brandKit.brand_name||'';
      document.getElementById('bkDesc').value=brandKit.brand_description||'';
      document.getElementById('bkFontPrimary').value=brandKit.font_primary||'Inter';
      document.getElementById('bkFontSecondary').value=brandKit.font_secondary||'Georgia';
      setColor('bkColorPrimary','bkColorPrimaryHex',brandKit.primary_color||'#000000');
      setColor('bkColorSecondary','bkColorSecondaryHex',brandKit.secondary_color||'#ffffff');
      setColor('bkColorAccent','bkColorAccentHex',brandKit.accent_color||'#ff6600');
      if(brandKit.logo_dark_path){document.getElementById('logoDarkPreview').src=brandKit.logo_dark_path;document.getElementById('logoDarkPreview').style.display='block';}
      if(brandKit.logo_light_path){document.getElementById('logoLightPreview').src=brandKit.logo_light_path;document.getElementById('logoLightPreview').style.display='block';}
      updateBrandPreview();
    }
  }catch(e){console.warn('Brand kit:',e.message);}
}
function setColor(pid,hid,v){document.getElementById(pid).value=v;document.getElementById(hid).value=v;}
function updateColorInput(pid,hid){document.getElementById(hid).value=document.getElementById(pid).value;updateBrandPreview();}
function syncColorPicker(hid,pid){const v=document.getElementById(hid).value;if(/^#[0-9a-f]{6}$/i.test(v))document.getElementById(pid).value=v;updateBrandPreview();}
function updateBrandPreview(){
  const name=document.getElementById('bkName').value||'Your Brand';
  const desc=document.getElementById('bkDesc').value.slice(0,80);
  const p=document.getElementById('bkColorPrimaryHex').value;
  const s=document.getElementById('bkColorSecondaryHex').value;
  const a=document.getElementById('bkColorAccentHex').value;
  document.getElementById('previewBrandName').textContent=name;
  document.getElementById('previewDesc').textContent=desc;
  document.getElementById('previewPrimary').style.background=p;
  document.getElementById('previewSecondary').style.background=s;
  document.getElementById('previewAccent').style.background=a;
  document.getElementById('brandPreview').style.background=p;
  document.getElementById('previewFont').textContent=document.getElementById('bkFontPrimary').value||'Inter';
  document.getElementById('previewFont2').textContent=document.getElementById('bkFontSecondary').value||'Georgia';
}
function scheduleBrandSave(){
  clearTimeout(brandSaveTimer);
  const s=document.getElementById('brandSaveStatus');
  s.style.display='block';s.textContent='Saving‚Ä¶';
  updateBrandPreview();
  brandSaveTimer=setTimeout(saveBrandKit,1200);
}
async function saveBrandKit(){
  try{
    await api('/api/brand-kit',{method:'PUT',body:JSON.stringify({clientId:currentClientId,brand_name:document.getElementById('bkName').value,brand_description:document.getElementById('bkDesc').value,primary_color:document.getElementById('bkColorPrimaryHex').value,secondary_color:document.getElementById('bkColorSecondaryHex').value,accent_color:document.getElementById('bkColorAccentHex').value,font_primary:document.getElementById('bkFontPrimary').value,font_secondary:document.getElementById('bkFontSecondary').value})});
    const s=document.getElementById('brandSaveStatus');
    s.textContent='Saved ‚úì';s.style.color='#34d399';
    setTimeout(()=>{s.style.display='none';s.style.color='';},2000);
  }catch(e){document.getElementById('brandSaveStatus').textContent='Save failed';toast(e.message,'error');}
}
async function uploadLogo(input,variant){
  if(!input.files[0])return;
  const fd=new FormData();fd.append(`logo_${variant}`,input.files[0]);fd.append('clientId',currentClientId);
  try{
    const res=await fetch('/api/brand-kit/logo',{method:'POST',body:fd});
    const data=await res.json();if(!res.ok)throw new Error(data.error);
    const pid=variant==='dark'?'logoDarkPreview':'logoLightPreview';
    const p=document.getElementById(pid);
    p.src=data.paths[`logo_${variant}_path`];p.style.display='block';
    toast('Logo uploaded');
  }catch(e){toast(e.message,'error');}
}
function switchBrandTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('brandKitTab').style.display=name==='kit'?'grid':'none';
  document.getElementById('brandAssetsTab').style.display=name==='assets-brand'?'block':'none';
}

// ‚îÄ‚îÄ Generate ‚îÄ‚îÄ
async function runGenerate(){
  if(!currentClientId){toast('Please select a client first','error');return;}
  const prompt=document.getElementById('genPrompt').value.trim();
  if(!prompt){toast('Enter a prompt first','error');return;}
  const btn=document.getElementById('genBtn');
  btn.disabled=true;
  btn.innerHTML=`<div class="loading-spinner"></div> Generating‚Ä¶`;
  const out=document.getElementById('genOutput');
  out.innerHTML=`<div class="card" style="padding:80px 20px;display:flex;flex-direction:column;align-items:center;gap:16px;min-height:400px;justify-content:center;"><div class="loading-spinner loading-spinner-lg"></div><p style="font-size:14px;color:var(--muted);">Creating your ad with FAL.ai‚Ä¶</p></div>`;
  try{
    const body={clientId:currentClientId,prompt,size:document.getElementById('genSize').value,num_images:parseInt(document.getElementById('genNumImages').value),use_brand_kit:document.getElementById('useBrandKit').checked,reference_image:document.getElementById('refImageUrlVal').value||undefined,product_image:document.getElementById('prodImageUrlVal').value||undefined};
    const profileId=document.getElementById('genProfileSelect').value;
    if(profileId)body.intelligenceProfileId=profileId;
    const{generation}=await api('/api/generate',{method:'POST',body:JSON.stringify(body)});
    renderGenerationOutput(generation);toast('Ad generated!');
  }catch(e){
    out.innerHTML=`<div class="card" style="padding:60px 20px;display:flex;flex-direction:column;align-items:center;gap:10px;"><div style="width:48px;height:48px;border-radius:12px;background:rgba(239,68,68,.1);display:flex;align-items:center;justify-content:center;font-size:22px;">‚úï</div><p style="font-weight:600;color:#f87171;">Generation failed</p><p style="font-size:12px;color:var(--muted);">${e.message}</p></div>`;
    toast(e.message,'error');
  }finally{
    btn.disabled=false;
    btn.innerHTML=`<svg style="width:16px;height:16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Generate Ad`;
  }
}

function renderGenerationOutput(gen){
  const images=Array.isArray(gen.images)?gen.images:[];
  const cols=images.length>1?'1fr 1fr':'1fr';
  document.getElementById('genOutput').innerHTML=`
    <div class="card" style="padding:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <span class="badge badge-green">‚úì Completed</span>
        <span style="font-size:11px;color:var(--muted);">${new Date(gen.created_at).toLocaleString()}</span>
      </div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.5;">${gen.prompt.slice(0,150)}${gen.prompt.length>150?'‚Ä¶':''}</p>
      <div style="display:grid;grid-template-columns:${cols};gap:10px;margin-bottom:12px;">
        ${images.map(img=>`
          <div style="position:relative;border-radius:10px;overflow:hidden;background:#000;">
            <img src="${img.url}" style="width:100%;object-fit:contain;display:block;cursor:pointer;max-height:500px;" onclick="window.open('${img.url}','_blank')"/>
            <button onclick="event.stopPropagation();downloadImage('${img.url}','ad-${Date.now()}-${img.index}.png')" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:white;border:none;cursor:pointer;font-size:11px;padding:4px 8px;border-radius:6px;backdrop-filter:blur(4px);">‚Üì Save</button>
          </div>
        `).join('')}
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="openRepromptModal(${gen.id})" class="btn btn-secondary btn-sm" style="flex:1;">üîÅ Re-prompt</button>
        <button onclick="saveAsTemplate(${gen.id},'${images[0]?.url||''}')" class="btn btn-secondary btn-sm" style="flex:1;">üìå Save Template</button>
      </div>
    </div>`;
}

async function composePrompt(){
  try{
    const body={clientId:currentClientId,referenceStyle:document.getElementById('refImageUrlVal').value,productDesc:document.getElementById('genPrompt').value,campaignGoal:''};
    const profileId=document.getElementById('genProfileSelect').value;
    if(profileId)body.intelligenceProfileId=profileId;
    const data=await api('/api/prompt/compose',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('genPrompt').value=data.prompt;
    toast(data.usedFallback?'Fallback prompt used':'Prompt composed by AI','info');
  }catch(e){toast(e.message,'error');}
}

async function generateConcepts(){
  try{
    const data=await api('/api/prompt/concepts',{method:'POST',body:JSON.stringify({clientId:currentClientId,campaignGoal:document.getElementById('genPrompt').value})});
    const concepts=data.concepts||[];
    document.getElementById('conceptsList').innerHTML=concepts.map((c,i)=>`
      <div class="card-glow" style="padding:12px;cursor:pointer;border-radius:10px;" onclick="applyConceptPrompt('${escape(c.prompt_template)}')">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:13px;font-weight:600;">${c.concept_type||'Concept '+(i+1)}</span>
          <span class="badge badge-blue">${c.audience_stage||''}</span>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:4px;">${c.angle||''}</p>
        <p style="font-size:12px;color:var(--muted2);font-style:italic;">"${(c.prompt_template||'').slice(0,100)}‚Ä¶"</p>
        <p style="font-size:11px;color:#a5b4fc;margin-top:6px;">Click to apply ‚Üí</p>
      </div>`).join('');
    openModal('conceptsModal');
  }catch(e){toast(e.message,'error');}
}
function applyConceptPrompt(enc){document.getElementById('genPrompt').value=unescape(enc);closeModal('conceptsModal');}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
async function loadHistory(reset=true){
  if(reset)historyOffset=0;
  try{
    const{generations,total}=await api(`/api/generate/history?clientId=${currentClientId}&limit=20&offset=${historyOffset}`);
    historyTotal=total;
    const grid=document.getElementById('historyGrid');
    if(reset)grid.innerHTML='';
    if(!generations.length&&reset){
      grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--muted);">No generations yet. Create your first ad!</div>`;
      return;
    }
    grid.innerHTML+=generations.map(gen=>{
      const images=Array.isArray(gen.images)?gen.images:[];
      const img=images[0]?.url||'';
      return `
        <div class="gen-card" onclick="openGenDetail(${JSON.stringify(gen).replace(/"/g,'&quot;')})">
          ${img?`<img src="${img}" style="width:100%;height:200px;object-fit:cover;" onerror="this.style.display='none'"/>`:
            `<div style="height:200px;display:flex;align-items:center;justify-content:center;background:var(--surface2);color:var(--muted);font-size:12px;">${gen.status==='failed'?'‚úï Failed':'‚è≥ Pending'}</div>`}
          <div style="padding:10px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
              <span class="badge ${gen.status==='completed'?'badge-green':gen.status==='failed'?'badge-red':'badge-yellow'}">${gen.status}</span>
              <span style="font-size:10px;color:var(--muted);">${images.length} img</span>
            </div>
            <p style="font-size:11px;color:var(--muted);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${gen.prompt}</p>
          </div>
          <div class="gen-overlay">
            <button onclick="event.stopPropagation();openGenDetail(${JSON.stringify(gen).replace(/"/g,'&quot;')})" class="btn btn-secondary btn-sm">Details</button>
            <button onclick="event.stopPropagation();deleteGeneration(${gen.id})" class="btn btn-danger btn-sm">Delete</button>
          </div>
        </div>`;
    }).join('');
    document.getElementById('loadMoreBtn').style.display=historyOffset+20>=historyTotal?'none':'inline-flex';
  }catch(e){toast(e.message,'error');}
}
async function loadMoreHistory(){historyOffset+=20;await loadHistory(false);}

function openGenDetail(gen){
  const images=Array.isArray(gen.images)?gen.images:[];
  document.getElementById('genDetailContent').innerHTML=`
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <span class="badge ${gen.status==='completed'?'badge-green':gen.status==='failed'?'badge-red':'badge-yellow'}">${gen.status}</span>
        <span class="badge badge-indigo">${gen.size}</span>
        ${gen.use_brand_kit?'<span class="badge badge-purple">Brand Kit</span>':''}
      </div>
      <p style="font-size:13px;color:var(--muted2);line-height:1.5;">${gen.prompt}</p>
      ${gen.error_message?`<p style="font-size:12px;color:#f87171;">Error: ${gen.error_message}</p>`:''}
      <div style="display:grid;grid-template-columns:${images.length>1?'1fr 1fr':'1fr'};gap:10px;">
        ${images.map(img=>`<a href="${img.url}" target="_blank"><img src="${img.url}" style="width:100%;border-radius:10px;object-contain;background:#000;max-height:280px;"/></a>`).join('')}
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="openRepromptModal(${gen.id});closeModal('genDetailModal')" class="btn btn-secondary btn-sm">üîÅ Re-prompt</button>
        ${images[0]?`<button onclick="saveAsTemplate(${gen.id},'${images[0].url}');closeModal('genDetailModal')" class="btn btn-secondary btn-sm">üìå Save Template</button>`:''}
        <button onclick="deleteGeneration(${gen.id});closeModal('genDetailModal')" class="btn btn-danger btn-sm">Delete</button>
      </div>
    </div>`;
  openModal('genDetailModal');
}
async function deleteGeneration(id){
  if(!confirm('Delete this generation?'))return;
  try{await api(`/api/generate/${id}`,{method:'DELETE'});toast('Deleted');loadHistory();}
  catch(e){toast(e.message,'error');}
}
function openRepromptModal(genId){
  const instruction=prompt('Enter variation instruction:');
  if(!instruction)return;
  runEdit(genId,instruction);
}
async function runEdit(parentId,editInstruction){
  try{
    const{generation}=await api('/api/generate/edit',{method:'POST',body:JSON.stringify({clientId:currentClientId,parentId,editInstruction})});
    renderGenerationOutput(generation);
    showSection('generate',document.querySelector('[data-section=generate]'));
    toast('Variation generated!');
  }catch(e){toast(e.message,'error');}
}
async function saveAsTemplate(genId,imageUrl){
  const name=prompt('Template name:');if(!name)return;
  try{
    await api('/api/templates/save-from-generation',{method:'POST',body:JSON.stringify({clientId:currentClientId,generationId:genId,imageUrl,name})});
    toast('Saved as template!');
  }catch(e){toast(e.message,'error');}
}

// ‚îÄ‚îÄ Intelligence ‚îÄ‚îÄ
async function loadIntelligence(){
  try{
    const{profiles}=await api(`/api/intelligence?clientId=${currentClientId}`);
    const el=document.getElementById('intelligenceList');
    if(!profiles.length){
      el.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--muted);">No profiles yet. Generate AI profiles or add manually.</div>`;
      return;
    }
    el.innerHTML=profiles.map(p=>`
      <div class="card-glow" style="padding:16px;border-radius:12px;">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;">
          <div>
            <h3 style="font-size:14px;font-weight:600;margin-bottom:4px;">${p.persona}</h3>
            <span class="badge ${p.source==='ai'?'badge-indigo':'badge-blue'}">${p.source==='ai'?'‚ú® AI Generated':'Manual'}</span>
          </div>
          <div style="display:flex;gap:6px;">
            <button onclick="openEditProfileModal(${JSON.stringify(p).replace(/"/g,'&quot;')})" class="btn btn-ghost btn-xs">Edit</button>
            <button onclick="deleteProfile(${p.id})" class="btn btn-danger btn-xs">Del</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:5px;">
          ${p.pain_point?`<div style="display:flex;gap:6px;font-size:12px;"><span style="color:var(--muted);flex-shrink:0;">Pain:</span><span style="color:var(--muted2);">${p.pain_point}</span></div>`:''}
          ${p.angle?`<div style="display:flex;gap:6px;font-size:12px;"><span style="color:var(--muted);flex-shrink:0;">Angle:</span><span style="color:var(--muted2);">${p.angle}</span></div>`:''}
          ${p.emotion?`<div style="display:flex;gap:6px;font-size:12px;"><span style="color:var(--muted);flex-shrink:0;">Emotion:</span><span style="color:var(--muted2);">${p.emotion}</span></div>`:''}
          ${p.copy_hook?`<div style="margin-top:8px;padding:8px 10px;background:rgba(99,102,241,.08);border-radius:7px;border-left:2px solid #6366f1;font-size:12px;color:#a5b4fc;font-style:italic;">"${p.copy_hook}"</div>`:''}
        </div>
      </div>`).join('');
    await loadProfilesForSelect();
  }catch(e){toast(e.message,'error');}
}
async function loadProfilesForSelect(){
  try{
    const{profiles}=await api(`/api/intelligence?clientId=${currentClientId}`);
    const sel=document.getElementById('genProfileSelect');
    sel.innerHTML=`<option value="">None</option>`+profiles.map(p=>`<option value="${p.id}">${p.persona.slice(0,40)}</option>`).join('');
  }catch(_){}
}
function openGenerateIntelligenceModal(){openModal('generateIntelModal');}
function openAddProfileModal(){openModal('addProfileModal');}
async function generateIntelligence(){
  try{
    const{profiles}=await api('/api/intelligence/generate',{method:'POST',body:JSON.stringify({clientId:currentClientId,researchText:document.getElementById('intelResearch').value,numProfiles:parseInt(document.getElementById('intelNumProfiles').value)})});
    closeModal('generateIntelModal');
    toast(`Generated ${profiles.length} profiles`);
    loadIntelligence();
  }catch(e){toast(e.message,'error');}
}
async function saveProfile(){
  const persona=document.getElementById('profPersona').value.trim();
  if(!persona){toast('Persona is required','error');return;}
  try{
    await api('/api/intelligence',{method:'POST',body:JSON.stringify({clientId:currentClientId,persona,pain_point:document.getElementById('profPain').value,angle:document.getElementById('profAngle').value,visual_direction:document.getElementById('profVisual').value,emotion:document.getElementById('profEmotion').value,copy_hook:document.getElementById('profHook').value})});
    closeModal('addProfileModal');toast('Profile saved');loadIntelligence();
    ['profPersona','profPain','profAngle','profVisual','profEmotion','profHook'].forEach(id=>document.getElementById(id).value='');
  }catch(e){toast(e.message,'error');}
}
function openEditProfileModal(p){
  document.getElementById('editProfileId').value=p.id;
  document.getElementById('editProfPersona').value=p.persona||'';
  document.getElementById('editProfPain').value=p.pain_point||'';
  document.getElementById('editProfAngle').value=p.angle||'';
  document.getElementById('editProfVisual').value=p.visual_direction||'';
  document.getElementById('editProfEmotion').value=p.emotion||'';
  document.getElementById('editProfHook').value=p.copy_hook||'';
  openModal('editProfileModal');
}
async function updateProfile(){
  const id=document.getElementById('editProfileId').value;
  try{
    await api(`/api/intelligence/${id}`,{method:'PATCH',body:JSON.stringify({persona:document.getElementById('editProfPersona').value,pain_point:document.getElementById('editProfPain').value,angle:document.getElementById('editProfAngle').value,visual_direction:document.getElementById('editProfVisual').value,emotion:document.getElementById('editProfEmotion').value,copy_hook:document.getElementById('editProfHook').value})});
    closeModal('editProfileModal');toast('Profile updated');loadIntelligence();
  }catch(e){toast(e.message,'error');}
}
async function deleteProfile(id){
  if(!confirm('Delete this profile?'))return;
  try{await api(`/api/intelligence/${id}`,{method:'DELETE'});toast('Deleted');loadIntelligence();}
  catch(e){toast(e.message,'error');}
}

// ‚îÄ‚îÄ Assets ‚îÄ‚îÄ
let currentAssetFilter='';
async function loadAssets(category=currentAssetFilter){
  currentAssetFilter=category;
  try{
    const params=new URLSearchParams({clientId:currentClientId});
    if(category)params.set('category',category);
    const{assets}=await api(`/api/assets?${params}`);
    const grid=document.getElementById('assetsGrid');
    if(!assets.length){
      grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);font-size:13px;">No assets yet. Upload brand images to get started.</div>`;
      return;
    }
    grid.innerHTML=assets.map(a=>`
      <div style="position:relative;border-radius:10px;overflow:hidden;background:var(--surface);border:1px solid var(--border);transition:transform .15s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
        <img src="${a.file_path}" style="width:100%;height:130px;object-fit:cover;display:block;" onerror="this.style.background='var(--surface2)'"/>
        <div style="position:absolute;inset:0;background:linear-gradient(to top,rgba(7,8,15,.9) 40%,transparent);opacity:0;transition:opacity .2s;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:8px;gap:4px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
          <button onclick="copyAssetUrl('${a.file_path}')" class="btn btn-secondary btn-xs" style="width:100%;">Copy URL</button>
          <button onclick="deleteAsset(${a.id})" class="btn btn-danger btn-xs" style="width:100%;">Delete</button>
        </div>
        <div style="padding:6px 8px;display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px;">${a.original_name}</span>
          <span class="badge badge-blue" style="font-size:10px;">${a.category.replace('_',' ')}</span>
        </div>
      </div>`).join('');
  }catch(e){toast(e.message,'error');}
}
function filterAssets(cat){loadAssets(cat);}
async function uploadAssets(input){
  if(!input.files.length)return;
  const fd=new FormData();
  Array.from(input.files).forEach(f=>fd.append('files',f));
  fd.append('clientId',currentClientId);
  try{
    const res=await fetch('/api/assets',{method:'POST',body:fd});
    const data=await res.json();if(!res.ok)throw new Error(data.error);
    pendingAssetIds=data.assets.map(a=>a.id);
    input.value='';openModal('assetCategoryModal');
    toast(`${data.assets.length} file(s) uploaded`);
  }catch(e){toast(e.message,'error');}
}
async function applyAssetCategory(){
  const cat=document.getElementById('assetCategorySelect').value;
  try{
    for(const id of pendingAssetIds)await api(`/api/assets/${id}`,{method:'PATCH',body:JSON.stringify({category:cat})});
    closeModal('assetCategoryModal');pendingAssetIds=[];loadAssets();toast('Categories applied');
  }catch(e){toast(e.message,'error');}
}
function copyAssetUrl(path){navigator.clipboard.writeText(window.location.origin+path);toast('URL copied');}
async function deleteAsset(id){
  if(!confirm('Delete asset?'))return;
  try{await api(`/api/assets/${id}`,{method:'DELETE'});toast('Deleted');loadAssets();}
  catch(e){toast(e.message,'error');}
}

// ‚îÄ‚îÄ Templates ‚îÄ‚îÄ
async function loadTemplates(){
  try{
    const params=new URLSearchParams({clientId:currentClientId});
    const search=document.getElementById('templateSearch')?.value;
    const cat=document.getElementById('templateCategory')?.value;
    if(search)params.set('search',search);if(cat)params.set('category',cat);
    const{templates}=await api(`/api/templates?${params}`);
    const grid=document.getElementById('templatesGrid');
    if(!templates.length){grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No templates yet.</div>`;return;}
    grid.innerHTML=templates.map(t=>`
      <div class="card-glow" style="border-radius:12px;overflow:hidden;">
        ${t.file_path?`<img src="${t.file_path}" style="width:100%;height:180px;object-fit:cover;display:block;"/>`:
          `<div style="height:180px;display:flex;align-items:center;justify-content:center;background:var(--surface2);color:var(--muted);font-size:12px;">${t.category}</div>`}
        <div style="padding:10px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <h3 style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:130px;">${t.name}</h3>
            <button onclick="toggleFavorite(${t.id},${!t.is_favorite})" style="background:none;border:none;cursor:pointer;font-size:14px;">${t.is_favorite?'‚≠ê':'‚òÜ'}</button>
          </div>
          <p style="font-size:10px;color:var(--muted);margin-bottom:8px;">${t.category}</p>
          <div style="display:flex;gap:6px;">
            <button onclick="useAsReference('${t.file_path}')" class="btn btn-secondary btn-xs" style="flex:1;">Use as Ref</button>
            <button onclick="deleteTemplate(${t.id})" class="btn btn-danger btn-xs">Del</button>
          </div>
        </div>
      </div>`).join('');
  }catch(e){toast(e.message,'error');}
}
async function uploadTemplate(input){
  if(!input.files[0])return;
  const name=prompt('Template name:')||input.files[0].name;
  const fd=new FormData();fd.append('file',input.files[0]);fd.append('clientId',currentClientId);fd.append('name',name);
  try{
    const res=await fetch('/api/templates',{method:'POST',body:fd});
    const data=await res.json();if(!res.ok)throw new Error(data.error);
    input.value='';toast('Template uploaded');loadTemplates();
  }catch(e){toast(e.message,'error');}
}
async function toggleFavorite(id,isFav){
  try{await api(`/api/templates/${id}`,{method:'PATCH',body:JSON.stringify({is_favorite:isFav})});loadTemplates();}
  catch(e){toast(e.message,'error');}
}
async function deleteTemplate(id){
  if(!confirm('Delete template?'))return;
  try{await api(`/api/templates/${id}`,{method:'DELETE'});toast('Deleted');loadTemplates();}
  catch(e){toast(e.message,'error');}
}
function useAsReference(path){
  document.getElementById('refImageUrlVal').value=window.location.origin+path;
  showSection('generate',document.querySelector('[data-section=generate]'));
  toast('Reference image set');
}

// ‚îÄ‚îÄ Campaign ‚îÄ‚îÄ
async function loadCampaignProfiles(){
  try{
    const{profiles}=await api(`/api/intelligence?clientId=${currentClientId}`);
    const el=document.getElementById('campProfileList');
    if(!profiles.length){el.innerHTML=`<p style="font-size:12px;color:var(--muted);">No profiles. Add some in Brand Intelligence first.</p>`;return;}
    el.innerHTML=profiles.map(p=>`
      <label style="display:flex;align-items:flex-start;gap:8px;padding:8px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--border2)'" onmouseout="if(!this.querySelector('input').checked)this.style.borderColor='transparent'">
        <input type="checkbox" value="${p.id}" class="camp-profile-check" style="margin-top:2px;" onchange="updateStep(3)"/>
        <div>
          <p style="font-size:12px;font-weight:500;">${p.persona}</p>
          <p style="font-size:11px;color:var(--muted);">${p.angle||''}</p>
        </div>
      </label>`).join('');
  }catch(e){}
}
function updateStep(n){
  for(let i=1;i<=6;i++){
    const el=document.getElementById(`step${i}Circle`);if(!el)continue;
    el.className='step-circle '+(i<n?'step-done':i===n?'step-active':'step-pending');
  }
}
async function buildPlan(){
  const profileIds=Array.from(document.querySelectorAll('.camp-profile-check:checked')).map(c=>parseInt(c.value));
  if(!profileIds.length){toast('Select at least one profile','error');return;}
  try{
    const data=await api('/api/campaign/plan',{method:'POST',body:JSON.stringify({clientId:currentClientId,profileIds,campaignGoal:document.getElementById('campGoal').value,referenceImageUrl:document.getElementById('campRefUrl').value,productImageUrl:document.getElementById('campProdUrl').value,adsPerProfile:parseInt(document.getElementById('campAdsPerProfile').value),size:document.getElementById('campSize').value})});
    campaignPlan=data.plan;
    document.getElementById('campPlanDisplay').innerHTML=`
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;">
        <span class="badge badge-indigo">${data.totalAds} ads planned</span>
        <span class="badge badge-blue">${data.profiles} profiles</span>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        ${data.plan.map((item,i)=>`<div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted2);"><span class="badge badge-green" style="font-size:10px;">${i+1}</span>${item.persona.slice(0,50)} <span style="color:var(--muted);">¬∑V${item.variantIndex}</span></div>`).join('')}
      </div>`;
    document.getElementById('campGenBtn').disabled=false;
    updateStep(5);toast(`Plan built: ${data.totalAds} ads`);
  }catch(e){toast(e.message,'error');}
}
async function runCampaign(){
  if(!campaignPlan.length){toast('Build a plan first','error');return;}
  const btn=document.getElementById('campGenBtn');
  btn.disabled=true;btn.innerHTML='<div class="loading-spinner"></div> Running‚Ä¶';
  updateStep(6);
  const resultsEl=document.getElementById('campResults');
  resultsEl.innerHTML=`<div style="display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted);"><div class="loading-spinner"></div>Generating ${campaignPlan.length} ads‚Ä¶</div>`;
  try{
    const{results,summary}=await api('/api/campaign/generate',{method:'POST',body:JSON.stringify({clientId:currentClientId,plan:campaignPlan})});
    resultsEl.innerHTML=`
      <div style="display:flex;gap:6px;margin-bottom:10px;">
        <span class="badge badge-green">${summary.succeeded} succeeded</span>
        ${summary.failed?`<span class="badge badge-red">${summary.failed} failed</span>`:''}
      </div>
      ${results.map(r=>{
        const images=r.generation?.images||[];
        return `<div style="display:flex;gap:10px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:8px;">
          ${images[0]?`<img src="${images[0].url}" style="width:52px;height:52px;object-fit:cover;border-radius:6px;flex-shrink:0;"/>`:
            `<div style="width:52px;height:52px;background:var(--surface2);border-radius:6px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px;">${r.status==='failed'?'‚úï':'‚è≥'}</div>`}
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
              <span class="badge ${r.status==='success'?'badge-green':'badge-red'}" style="font-size:10px;">${r.status}</span>
              <span style="font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${(r.persona||'').slice(0,40)}</span>
            </div>
            ${r.error?`<p style="font-size:11px;color:#f87171;">${r.error}</p>`:''}
          </div>
        </div>`;
      }).join('')}`;
    toast(`Campaign done: ${summary.succeeded}/${summary.total} succeeded`);
  }catch(e){
    resultsEl.innerHTML=`<p style="color:#f87171;font-size:13px;">${e.message}</p>`;
    toast(e.message,'error');
  }finally{btn.disabled=false;btn.innerHTML='‚ñ∂ Run Campaign';}
}

// ‚îÄ‚îÄ Reverse ‚îÄ‚îÄ
function openReverseModal(){document.getElementById('reverseResults').style.display='none';openModal('reverseModal');}
async function runReverse(){
  const imageUrl=document.getElementById('reverseImageUrl').value.trim();
  if(!imageUrl){toast('Image URL required','error');return;}
  try{
    reverseData=await api('/api/prompt/reverse',{method:'POST',body:JSON.stringify({imageUrl,campaignGoal:document.getElementById('reverseCampaignGoal').value})});
    document.getElementById('reverseStylePrompt').textContent=reverseData.style_prompt||'';
    document.getElementById('reverseCopySkeleton').textContent=reverseData.copy_skeleton||'';
    document.getElementById('reverseVariants').innerHTML=(reverseData.variant_prompts||[]).map((p,i)=>`
      <div class="card" style="padding:10px;">
        <p style="font-size:11px;color:var(--muted);margin-bottom:4px;">Variant ${i+1}</p>
        <p style="font-size:12px;line-height:1.5;">${p}</p>
        <button onclick="applyVariantPrompt('${escape(p)}')" class="btn btn-secondary btn-xs" style="margin-top:6px;">Apply ‚Üí</button>
      </div>`).join('');
    document.getElementById('reverseResults').style.display='flex';
    document.getElementById('reverseResults').style.flexDirection='column';
    document.getElementById('reverseResults').style.gap='10px';
  }catch(e){toast(e.message,'error');}
}
function applyReversePrompt(){
  if(!reverseData?.style_prompt)return;
  document.getElementById('genPrompt').value=reverseData.style_prompt;
  closeModal('reverseModal');
  showSection('generate',document.querySelector('[data-section=generate]'));
}
function applyVariantPrompt(enc){
  document.getElementById('genPrompt').value=unescape(enc);
  closeModal('reverseModal');
  showSection('generate',document.querySelector('[data-section=generate]'));
}

// ‚îÄ‚îÄ Image helpers ‚îÄ‚îÄ
function handleDragOver(e,zoneId){e.preventDefault();document.getElementById(zoneId).classList.add('drag-over');}
function handleDrop(e,zoneId,previewId,imgId){
  e.preventDefault();document.getElementById(zoneId).classList.remove('drag-over');
  const file=e.dataTransfer.files[0];
  if(file&&file.type.startsWith('image/')){
    const reader=new FileReader();
    reader.onload=ev=>{document.getElementById(imgId).src=ev.target.result;document.getElementById(previewId).style.display='block';};
    reader.readAsDataURL(file);
  }
}
function previewImage(input,previewId,imgId){
  if(!input.files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{document.getElementById(imgId).src=e.target.result;document.getElementById(previewId).style.display='block';};
  reader.readAsDataURL(input.files[0]);
}
function clearImage(previewId,urlId){
  document.getElementById(previewId).style.display='none';
  if(urlId&&document.getElementById(urlId))document.getElementById(urlId).value='';
}

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
async function loadSettings(){
  try{
    const{settings}=await api('/api/settings');
    // Update individual status badges
    renderKeyStatus('falStatus',       settings['fal_key']);
    renderKeyStatus('geminiStatus',    settings['gemini_api_key']);
    renderKeyStatus('leonardoStatus',  settings['leonardo_api_key']);
    renderKeyStatus('mistralStatus',   settings['mistral_api_key']);

    // Update status grid
    const grid=document.getElementById('settingsStatusGrid');
    const items=[
      {label:'FAL.ai',       key:'fal_key',           icon:'üü†'},
      {label:'Leonardo.ai',  key:'leonardo_api_key',  icon:'üü£'},
      {label:'Gemini',       key:'gemini_api_key',    icon:'üîµ'},
      {label:'Mistral AI',   key:'mistral_api_key',   icon:'üü°'},
    ];
    grid.innerHTML=items.map(item=>{
      const s=settings[item.key]||{set:false,source:'not set',masked:''};
      return`<div style="padding:12px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <span>${item.icon}</span>
          <span style="font-size:13px;font-weight:600;">${item.label}</span>
          <span class="badge ${s.set?'badge-green':'badge-red'}" style="margin-left:auto;">${s.set?'‚úì Set':'Not Set'}</span>
        </div>
        <div style="font-size:11px;color:var(--muted);">Source: ${s.source}</div>
        ${s.set?`<div style="font-size:11px;color:var(--muted2);font-family:monospace;margin-top:2px;">${s.masked}</div>`:''}
      </div>`;
    }).join('');

    // Pre-fill model selects from status
    const gemModel=settings['gemini_model'];
    if(gemModel?.set){
      const sel=document.getElementById('geminiModelInput');
      const opt=sel.querySelector(`option[value="${gemModel.masked}"]`);
      if(!opt){const o=document.createElement('option');o.value=gemModel.masked;o.textContent=gemModel.masked;sel.appendChild(o);}
      sel.value=gemModel.masked||'gemini-1.5-flash';
    }
    const misModel=settings['mistral_model'];
    if(misModel?.set){
      const sel=document.getElementById('mistralModelInput');
      const opt=sel.querySelector(`option[value="${misModel.masked}"]`);
      if(!opt){const o=document.createElement('option');o.value=misModel.masked;o.textContent=misModel.masked;sel.appendChild(o);}
      sel.value=misModel.masked||'mistral-small-latest';
    }
  }catch(e){console.warn('Settings load:',e.message);}
}

function renderKeyStatus(elId,status){
  const el=document.getElementById(elId);
  if(!el)return;
  if(!status){el.innerHTML='';return;}
  el.innerHTML=`<span class="badge ${status.set?'badge-green':'badge-red'}" style="font-size:10px;">${status.set?'‚úì Set':'Not Set'}</span>`;
}

async function saveKey(dbKey,inputId,statusElId){
  const val=document.getElementById(inputId).value.trim();
  if(!val){toast('Enter a value first','error');return;}
  try{
    await api('/api/settings',{method:'PUT',body:JSON.stringify({[dbKey]:val})});
    document.getElementById(inputId).value='';
    toast('API key saved');
    loadSettings();
  }catch(e){toast(e.message,'error');}
}

async function saveLeonardoKeys(){
  const key=document.getElementById('leonardoKeyInput').value.trim();
  const model=document.getElementById('leonardoModelInput').value.trim();
  const body={};
  if(key)body['leonardo_api_key']=key;
  if(model)body['leonardo_model_id']=model;
  if(!Object.keys(body).length){toast('Enter at least the API key','error');return;}
  try{
    await api('/api/settings',{method:'PUT',body:JSON.stringify(body)});
    document.getElementById('leonardoKeyInput').value='';
    toast('Leonardo settings saved');
    loadSettings();
  }catch(e){toast(e.message,'error');}
}

async function saveGeminiKeys(){
  const key=document.getElementById('geminiKeyInput').value.trim();
  const model=document.getElementById('geminiModelInput').value;
  const body={};
  if(key)body['gemini_api_key']=key;
  if(model)body['gemini_model']=model;
  if(!Object.keys(body).length){toast('Enter at least the API key','error');return;}
  try{
    await api('/api/settings',{method:'PUT',body:JSON.stringify(body)});
    document.getElementById('geminiKeyInput').value='';
    toast('Gemini settings saved');
    loadSettings();
  }catch(e){toast(e.message,'error');}
}

async function saveMistralKeys(){
  const key=document.getElementById('mistralKeyInput').value.trim();
  const model=document.getElementById('mistralModelInput').value;
  const body={};
  if(key)body['mistral_api_key']=key;
  if(model)body['mistral_model']=model;
  if(!Object.keys(body).length){toast('Enter at least the API key','error');return;}
  try{
    await api('/api/settings',{method:'PUT',body:JSON.stringify(body)});
    document.getElementById('mistralKeyInput').value='';
    toast('Mistral AI settings saved');
    loadSettings();
  }catch(e){toast(e.message,'error');}
}

async function removeKey(dbKey,statusElId){
  if(!confirm('Remove this API key from the database? The .env value (if any) will still be used.'))return;
  try{
    await api(`/api/settings/${dbKey}`,{method:'DELETE'});
    toast('Key removed');
    loadSettings();
  }catch(e){toast(e.message,'error');}
}

function toggleVisible(inputId){
  const el=document.getElementById(inputId);
  el.type=el.type==='password'?'text':'password';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTOPOSTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const AP_PLATFORM_COLORS={
  instagram:'background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:white;',
  tiktok:'background:#010101;color:white;',
  youtube:'background:#ff0000;color:white;',
  linkedin:'background:#0077b5;color:white;',
  facebook:'background:#1877f2;color:white;',
  pinterest:'background:#e60023;color:white;',
};
const AP_STATUS_COLORS={
  draft:'background:var(--surface2);color:var(--muted2);border:1px solid var(--border);',
  scheduled:'background:rgba(59,130,246,.15);color:#60a5fa;',
  posting:'background:rgba(251,191,36,.15);color:#fbbf24;',
  posted:'background:rgba(52,211,153,.15);color:#34d399;',
  failed:'background:rgba(248,113,113,.15);color:#f87171;',
};

let _apVideoFile=null;
let _apImageFile=null;
let _apQueueFilter='all';

function switchAPTab(tab,el){
  document.querySelectorAll('.ap-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.ap-tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('ap-tab-'+tab).classList.add('active');
  if(tab==='queue')loadAPQueue();
}

function handleAPVideoUpload(file){
  if(!file)return;
  _apVideoFile=file;
  const zone=document.getElementById('apVideoDropZone');
  zone.innerHTML=`<div style="display:flex;align-items:center;gap:12px;">
    <svg style="width:32px;height:32px;color:var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
    <div style="text-align:left;">
      <div style="font-size:13px;font-weight:500;color:var(--text);">${file.name}</div>
      <div style="font-size:11px;color:var(--muted);">${(file.size/1024/1024).toFixed(1)} MB</div>
    </div>
  </div>`;
  document.getElementById('apVideoUploadBtn').style.display='block';
}

function handleAPImageUpload(file){
  if(!file)return;
  _apImageFile=file;
  const zone=document.getElementById('apImageDropZone');
  zone.innerHTML=`<div style="display:flex;align-items:center;gap:12px;">
    <svg style="width:32px;height:32px;color:var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
    <div style="text-align:left;">
      <div style="font-size:13px;font-weight:500;color:var(--text);">${file.name}</div>
      <div style="font-size:11px;color:var(--muted);">${(file.size/1024/1024).toFixed(1)} MB</div>
    </div>
  </div>`;
  document.getElementById('apImageUploadBtn').style.display='block';
}

async function uploadAPVideo(){
  if(!_apVideoFile){toast('Select a video first','error');return;}
  const btn=document.getElementById('apVideoUploadBtn');
  btn.disabled=true;btn.textContent='Uploading & generating metadata...';
  try{
    const fd=new FormData();
    fd.append('video',_apVideoFile);
    fd.append('description',document.getElementById('apVideoDesc').value);
    if(currentClientId)fd.append('clientId',currentClientId);
    const res=await fetch('/api/autoposter/upload-video',{method:'POST',body:fd});
    const data=await res.json();
    if(!res.ok)throw new Error(data.error||'Upload failed');
    toast('Video uploaded! AI metadata generated for 3 platforms.');
    renderAPUploadResults(data.posts);
    _apVideoFile=null;
    btn.style.display='none';
  }catch(e){toast(e.message,'error');}
  finally{btn.disabled=false;btn.textContent='Upload & Generate Metadata';}
}

async function uploadAPImage(){
  if(!_apImageFile){toast('Select an image first','error');return;}
  const btn=document.getElementById('apImageUploadBtn');
  btn.disabled=true;btn.textContent='Uploading & generating metadata...';
  try{
    const fd=new FormData();
    fd.append('image',_apImageFile);
    fd.append('description',document.getElementById('apImageDesc').value);
    if(currentClientId)fd.append('clientId',currentClientId);
    const res=await fetch('/api/autoposter/upload-image',{method:'POST',body:fd});
    const data=await res.json();
    if(!res.ok)throw new Error(data.error||'Upload failed');
    toast('Image uploaded! AI metadata generated for 3 platforms.');
    renderAPUploadResults(data.posts);
    _apImageFile=null;
    btn.style.display='none';
  }catch(e){toast(e.message,'error');}
  finally{btn.disabled=false;btn.textContent='Upload & Generate Metadata';}
}

function renderAPUploadResults(posts){
  const container=document.getElementById('apUploadResults');
  container.innerHTML=`<div style="font-size:14px;font-weight:600;margin-bottom:12px;">Generated Posts</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;">
      ${posts.map(p=>renderAPPostCard(p)).join('')}
    </div>`;
}

async function runAICreatePost(){
  const desc=document.getElementById('apAIDesc').value.trim();
  if(!desc){toast('Enter a post description','error');return;}
  const platforms=[...document.querySelectorAll('.ap-platform-cb:checked')].map(c=>c.value);
  if(!platforms.length){toast('Select at least one platform','error');return;}
  const tone=document.getElementById('apAITone').value;
  const useBrandKit=document.getElementById('apAIBrandKit').checked;

  const resultsEl=document.getElementById('apAIResults');
  resultsEl.innerHTML=`<div style="text-align:center;padding:40px;">
    <div class="spinner" style="margin:0 auto 16px;width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;"></div>
    <div style="font-size:13px;color:var(--muted);">Generating platform-specific content...</div>
    <div style="font-size:11px;color:var(--muted);margin-top:4px;">This may take a moment as images are generated for each platform</div>
  </div>`;

  try{
    const body={description:desc,tone,platforms,useBrandKit};
    if(currentClientId)body.clientId=currentClientId;
    const data=await api('/api/autoposter/ai-create',{method:'POST',body:JSON.stringify(body)});
    toast(`Created ${data.posts.length} posts across platforms!`);
    resultsEl.innerHTML=`<div style="font-size:14px;font-weight:600;margin-bottom:12px;">AI-Created Posts</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;">
        ${data.posts.map(p=>renderAPPostCard(p)).join('')}
      </div>`;
  }catch(e){
    toast(e.message,'error');
    resultsEl.innerHTML='';
  }
}

function renderAPPostCard(post){
  const tags=Array.isArray(post.tags)?post.tags:(typeof post.tags==='string'?JSON.parse(post.tags||'[]'):post.tags||[]);
  const platform=post.platform||'unknown';
  const status=post.status||'draft';
  const mediaPreview=post.media_url
    ?`<img src="${post.media_url}" style="width:100%;height:160px;object-fit:cover;" onerror="this.style.display='none'"/>`
    :post.media_path
    ?`<div style="height:160px;background:var(--surface2);display:flex;align-items:center;justify-content:center;">
        <span style="font-size:11px;color:var(--muted);">${post.post_type==='video'?'Video':'Image'} ‚Äî ${post.media_path.split('/').pop()}</span>
      </div>`
    :post.thumbnail_url
    ?`<img src="${post.thumbnail_url}" style="width:100%;height:160px;object-fit:cover;" onerror="this.style.display='none'"/>`
    :`<div style="height:100px;background:var(--surface2);display:flex;align-items:center;justify-content:center;">
        <span style="font-size:11px;color:var(--muted);">No media</span>
      </div>`;

  return`<div class="ap-post-card">
    ${mediaPreview}
    <div style="padding:14px;">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
        <span class="ap-platform-badge" style="${AP_PLATFORM_COLORS[platform]||''}">${platform}</span>
        <span class="ap-status-badge" style="${AP_STATUS_COLORS[status]||''}">${status}</span>
        <span style="margin-left:auto;font-size:10px;color:var(--muted);">${post.content_width||''}x${post.content_height||''}</span>
      </div>
      <div style="font-size:13px;font-weight:600;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${post.title||'Untitled'}</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${post.description||''}</div>
      ${tags.length?`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;">${tags.slice(0,5).map(t=>`<span style="font-size:10px;padding:2px 6px;background:var(--surface2);border-radius:4px;color:var(--muted2);">#${t}</span>`).join('')}</div>`:''}
      <div style="display:flex;gap:6px;">
        ${status==='draft'||status==='failed'?`<button onclick="publishAPPost(${post.id})" class="btn btn-primary btn-sm" style="flex:1;font-size:11px;">Publish</button>`:''}
        <button onclick="editAPPost(${post.id})" class="btn btn-secondary btn-sm" style="font-size:11px;">Edit</button>
        <button onclick="deleteAPPost(${post.id})" class="btn btn-danger btn-sm" style="font-size:11px;">Delete</button>
      </div>
    </div>
  </div>`;
}

async function loadAPQueue(){
  const grid=document.getElementById('apQueueGrid');
  try{
    const params=new URLSearchParams();
    if(currentClientId)params.set('clientId',currentClientId);
    if(_apQueueFilter&&_apQueueFilter!=='all')params.set('status',_apQueueFilter);
    const data=await api('/api/autoposter/posts?'+params.toString());
    if(!data.posts.length){
      grid.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);font-size:13px;grid-column:1/-1;">No posts found.</div>';
      return;
    }
    grid.innerHTML=data.posts.map(p=>renderAPPostCard(p)).join('');
  }catch(e){
    grid.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted);font-size:13px;grid-column:1/-1;">Error loading posts: ${e.message}</div>`;
  }
}

function filterAPQueue(status,el){
  document.querySelectorAll('.ap-filter').forEach(f=>f.classList.remove('active'));
  el.classList.add('active');
  _apQueueFilter=status;
  loadAPQueue();
}

async function publishAPPost(id){
  if(!confirm('Publish this post?'))return;
  try{
    const data=await api(`/api/autoposter/posts/${id}/publish`,{method:'POST'});
    toast(data.message||'Published!');
    loadAPQueue();
  }catch(e){toast(e.message,'error');}
}

async function deleteAPPost(id){
  if(!confirm('Delete this post?'))return;
  try{
    await api(`/api/autoposter/posts/${id}`,{method:'DELETE'});
    toast('Post deleted');
    loadAPQueue();
  }catch(e){toast(e.message,'error');}
}

async function editAPPost(id){
  const newTitle=prompt('Edit post title:');
  if(newTitle===null)return;
  const newDesc=prompt('Edit post description:');
  try{
    const body={title:newTitle};
    if(newDesc!==null)body.description=newDesc;
    await api(`/api/autoposter/posts/${id}`,{method:'PATCH',body:JSON.stringify(body)});
    toast('Post updated');
    loadAPQueue();
  }catch(e){toast(e.message,'error');}
}

// ‚îÄ‚îÄ Social Connections (Settings page) ‚îÄ‚îÄ

const SOCIAL_PLATFORMS=[
  {id:'facebook',  name:'Facebook',  icon:'f',gradient:'linear-gradient(135deg,#1877f2,#0d65d9)'},
  {id:'instagram', name:'Instagram', icon:'IG',gradient:'linear-gradient(135deg,#f09433,#dc2743)'},
  {id:'youtube',   name:'YouTube',   icon:'YT',gradient:'linear-gradient(135deg,#ff0000,#cc0000)'},
  {id:'linkedin',  name:'LinkedIn',  icon:'in',gradient:'linear-gradient(135deg,#0077b5,#005e93)'},
  {id:'tiktok',    name:'TikTok',    icon:'TT',gradient:'linear-gradient(135deg,#010101,#333)'},
  {id:'pinterest', name:'Pinterest', icon:'P',gradient:'linear-gradient(135deg,#e60023,#c8001f)'},
];

async function loadSocialConnections(){
  const grid=document.getElementById('socialConnectionsGrid');
  if(!grid)return;
  let connections=[];
  try{
    const params=currentClientId?`?clientId=${currentClientId}`:'';
    const data=await api('/api/autoposter/connections'+params);
    connections=data.connections||[];
  }catch(e){console.warn('Social connections load:',e.message);}

  grid.innerHTML=SOCIAL_PLATFORMS.map(p=>{
    const conn=connections.find(c=>c.platform===p.id);
    const connected=conn&&conn.status==='connected';
    return`<div class="card" style="padding:16px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <div style="width:36px;height:36px;border-radius:8px;background:${p.gradient};display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:11px;">${p.icon}</div>
        <div style="flex:1;">
          <div style="font-size:13px;font-weight:600;">${p.name}</div>
          <div style="font-size:11px;color:var(--muted);">${connected?conn.platform_username||'Connected':'Not connected'}</div>
        </div>
        <span class="badge ${connected?'badge-green':'badge-red'}" style="font-size:10px;">${connected?'Connected':'Disconnected'}</span>
      </div>
      <label class="label">Access Token</label>
      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <input type="password" id="social_token_${p.id}" class="input" placeholder="Paste ${p.name} access token‚Ä¶" autocomplete="new-password" style="font-size:11px;"/>
        <button onclick="toggleVisible('social_token_${p.id}')" class="btn btn-secondary btn-sm" style="flex-shrink:0;font-size:11px;">üëÅ</button>
      </div>
      <div style="display:flex;gap:6px;">
        <button onclick="connectSocialPlatform('${p.id}')" class="btn btn-primary btn-sm" style="flex:1;font-size:11px;">Connect</button>
        ${connected?`<button onclick="disconnectSocialPlatform('${p.id}')" class="btn btn-danger btn-sm" style="font-size:11px;">Disconnect</button>`:''}
      </div>
    </div>`;
  }).join('');
}

async function connectSocialPlatform(platform){
  const token=document.getElementById('social_token_'+platform).value.trim();
  if(!token){toast('Enter an access token','error');return;}
  try{
    const body={platform,access_token:token};
    if(currentClientId)body.clientId=currentClientId;
    await api('/api/autoposter/connections',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('social_token_'+platform).value='';
    toast(`${platform} connected!`);
    loadSocialConnections();
  }catch(e){toast(e.message,'error');}
}

async function disconnectSocialPlatform(platform){
  if(!confirm(`Disconnect ${platform}?`))return;
  try{
    const params=currentClientId?`?clientId=${currentClientId}`:'';
    await api(`/api/autoposter/connections/${platform}${params}`,{method:'DELETE'});
    toast(`${platform} disconnected`);
    loadSocialConnections();
  }catch(e){toast(e.message,'error');}
}

// ‚îÄ‚îÄ Theme ‚îÄ‚îÄ
function applyTheme(isLight){
  document.body.classList.toggle('light',isLight);
  localStorage.setItem('theme',isLight?'light':'dark');
  // Sidebar toggle (checked = dark mode)
  const sideToggle=document.getElementById('sideThemeToggle');
  const sideIcon=document.getElementById('sideThemeIcon');
  const sideLabel=document.getElementById('sideThemeLabel');
  if(sideToggle)sideToggle.checked=!isLight;
  if(sideIcon)sideIcon.textContent=isLight?'‚òÄÔ∏è':'üåô';
  if(sideLabel)sideLabel.textContent=isLight?'Light Mode':'Dark Mode';
  // Settings page toggle
  const settingsToggle=document.getElementById('themeToggle');
  const settingsLabel=document.getElementById('themeLabel');
  const dayIcon=document.getElementById('themeIconDay');
  const nightIcon=document.getElementById('themeIconNight');
  if(settingsToggle)settingsToggle.checked=isLight;
  if(settingsLabel)settingsLabel.textContent=isLight?'Light':'Dark';
  if(dayIcon)dayIcon.style.opacity=isLight?'1':'.5';
  if(nightIcon)nightIcon.style.opacity=isLight?'.5':'1';
}
// Restore saved theme on load
(function(){
  const saved=localStorage.getItem('theme');
  applyTheme(saved==='light');
})();
</script>
</body>
</html>
